(function(){var t,e,r,i,o,h=function(t,e){function r(){this.constructor=t}for(var i in e)n.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},n={}.hasOwnProperty;o=ABM.Util,ABM.DataSet=e=function(){function e(t,e,r,i){null==t&&(t=0),null==e&&(e=0),null==r&&(r=[]),this.model=i,this.setDefaults(),this.reset(t,e,r)}return e.patchDataSet=function(t){return new i(t)},e.importImageDataSet=function(t,e,i,h,n){var a;return null==i&&(i=o.pixelByte(0)),null==h&&(h=Uint8ClampedArray),a=new r(null,i,h,n),o.importImage(t,function(t){return a.parse(t),null!=e?e(a):void 0}),a},e.importAscDataSet=function(e,r){var i;return i=new t,o.xhrLoadFile(e,"GET","text",function(t){return i.parse(t),null!=r?r(i):void 0}),i},e.prototype.reset=function(t,e,r){return this.width=t,this.height=e,this.data=r,this.data.length!==this.width*this.height&&o.error("DataSet: data array length error:\ndata.length: "+this.data.length+" width: "+this.width+" height: "+this.height),this},e.prototype.checkXY=function(t,e){return t>=0&&t<=this.width-1&&e>=0&&e<=this.height-1?void 0:o.error("x,y out of range: "+t+","+e)},e.prototype.setDefaults=function(){return this.useNearest=!1,this.crop=!1,this.normalizeImage=!0,this.alpha=255,this.gray=!0},e.prototype.setSampler=function(t){this.useNearest=t},e.prototype.setConvolveCrop=function(t){this.crop=t},e.prototype.setImageNormalize=function(t){this.normalizeImage=t},e.prototype.setImageAlpha=function(t){this.alpha=t},e.prototype.setImageGray=function(t){this.gray=t},e.prototype.setModel=function(t){this.model=t},e.prototype.sample=function(t,e){return this.useNearest?this.nearest(t,e):this.bilinear(t,e)},e.prototype.nearest=function(t,e){return this.getXY(Math.round(t),Math.round(e))},e.prototype.bilinear=function(t,e){var r,i,o,h,n,a,s,l,u,p,c,d,f;return this.checkXY(t,e),d=Math.floor(t),f=Math.floor(e),s=this.toIndex(d,f),c=this.width,t-=d,e-=f,r=1-t,i=1-e,o=this.data[s],h=null!=(l=this.data[s+c])?l:0,n=null!=(u=this.data[++s])?u:0,a=null!=(p=this.data[s+c])?p:0,o*r*i+n*t*i+h*r*e+a*t*e},e.prototype.toIndex=function(t,e){return t+e*this.width},e.prototype.toXY=function(t){return[t%this.width,Math.floor(t/this.width)]},e.prototype.getXY=function(t,e){return this.checkXY(t,e),this.data[this.toIndex(t,e)]},e.prototype.setXY=function(t,e,r){return this.checkXY(t,e),this.data[this.toIndex(t,e)]=r},e.prototype.toString=function(t,e){var r,i,h,n,a;for(null==t&&(t=2),null==e&&(e=", "),a="width: "+this.width+" height: "+this.height+" data:",r=0>t?this.data:o.aToFixed(this.data,t),i=h=0,n=this.height;n>=0?n>h:h>n;i=n>=0?++h:--h)a+="\n"+(i+": "+r.slice(i*this.width,(i+1)*this.width));return a.replace(/,/g,e)},e.prototype.toImage=function(){return this.toContext().canvas},e.prototype.toContext=function(){var t,e,r,i,h,n,a,s,l,u;for(t=o.createCtx(this.width,this.height),h=t.getImageData(0,0,this.width,this.height),u=h.data,r=this.normalizeImage?this.gray?o.normalize8(this.data):o.normalizeInt(this.data,0,Math.pow(2,24)-1):function(){var t,r,i,o;for(i=this.data,o=[],t=0,r=i.length;r>t;t++)e=i[t],o.push(Math.round(e));return o}.call(this),i=a=0,s=r.length;s>a;i=++a)l=r[i],n=4*i,this.gray?(u[n]=u[n+1]=u[n+2]=Math.floor(l),u[n+3]=this.alpha):(u[n]=l>>16&255,u[n+1]=l>>8&255,u[n+2]=255&l,u[n+3]=this.normalizeImage?this.alpha:u[n+3]=l>>24&255);return t.putImageData(h,0,0),t},e.prototype.toDataUrl=function(){return o.ctxToDataUrl(this.toContext())},e.prototype.toDrawing=function(t){var e;return null==t&&(t=this.model),t.patches.installDrawing(e=this.toImage()),e},e.prototype.toPatchColors=function(t){var e;return null==t&&(t=this.model),t.patches.installColors(e=this.toImage()),e},e.prototype.toPatchVar=function(t,e){var r,i,o,h,n,a,s;if(null==e&&(e=this.model),(s=e.patches).length===this.data.length)for(r=i=0,h=s.length;h>i;r=++i)a=s[r],a[t]=this.data[r];else for(o=0,n=s.length;n>o;o++)a=s[o],a[t]=this.patchSample(a.x,a.y,e);return null},e.prototype.coordSample=function(t,e,r,i,o,h){var n,a;return n=(t-r)*(this.width-1)/o,a=(i-e)*(this.height-1)/h,this.sample(n,a)},e.prototype.patchSample=function(t,e,r){var i;return null==r&&(r=this.model),i=r.world,this.coordSample(t,e,i.minXcor,i.maxYcor,i.numX,i.numY)},e.prototype.normalize=function(t,r){return new e(this.width,this.height,o.normalize(this.data,t,r),this.model)},e.prototype.normalize8=function(){return new e(this.width,this.height,o.normalize8(this.data),this.model)},e.prototype.resample=function(t,r){var i,o,h,n,a,s,l,u,p,c,d;if(t===this.width&&r===this.height)return new e(t,r,this.data,this.model);for(i=[],l=(this.width-1)/(t-1),c=(this.height-1)/(r-1),p=o=0,n=r;n>o;p=o+=1)for(s=h=0,a=t;a>h;s=h+=1)u=s*l,d=p*c,i.push(this.sample(u,d));return new e(t,r,i,this.model)},e.prototype.neighborhood=function(t,e,r){var i,h,n,a,s,l;for(null==r&&(r=[]),r.length=0,h=n=-1;1>=n;h=++n)for(i=a=-1;1>=a;i=++a)s=o.clamp(t+i,0,this.width-1),l=o.clamp(e+h,0,this.height-1),r.push(this.data[this.toIndex(s,l)]);return r},e.prototype.convolve=function(t,r){var i,h,n,a,s,l,u,p,c,d,f,g,m,y;for(null==r&&(r=1),i=[],s=[],this.crop?(g=y=1,h=this.height-1,d=this.width-1):(g=y=0,h=this.height,d=this.width),m=n=l=y,u=h;u>n;m=n+=1)for(f=a=p=g,c=d;c>a;f=a+=1)this.neighborhood(f,m,s),i.push(o.aSum(o.aPairMul(t,s))*r);return new e(d-g,h-y,i,this.model)},e.prototype.dzdx=function(t,e){return null==t&&(t=2),null==e&&(e=1/8),this.convolve([-1,0,1,-t,0,t,-1,0,1],e)},e.prototype.dzdy=function(t,e){return null==t&&(t=2),null==e&&(e=1/8),this.convolve([1,t,1,0,0,0,-1,-t,-1],e)},e.prototype.laplace8=function(){return this.convolve([-1,-1,-1,-1,8,-1,-1,-1,-1])},e.prototype.laplace4=function(){return this.convolve([0,-1,0,-1,4,-1,0,-1,0])},e.prototype.blur=function(t){return null==t&&(t=.0625),this.convolve([1,2,1,2,4,2,1,2,1],t)},e.prototype.edge=function(){return this.convolve([1,1,1,1,-7,1,1,1,1])},e.prototype.filter=function(t){var r;return new e(this.width,this.height,function(){var e,i,o,h;for(o=this.data,h=[],e=0,i=o.length;i>e;e++)r=o[e],h.push(t(r));return h}.call(this),this.model)},e.prototype.slopeAndAspect=function(t,r){var i,h,n,a,s,l,u,p,c,d,f,g,m,y,w;for(null==t&&(t=!0),null==r&&(r=!0),h=this.dzdx(),n=this.dzdy(),i=[],g=[],l=h.height,m=h.width,w=u=0,d=l;d>u;w=u+=1)for(y=p=0,f=m;f>p;y=p+=1){for(a=h.getXY(y,w),s=n.getXY(y,w),g.push(Math.atan(Math.sqrt(a*a+s*s)));t&&a===s;)a+=o.randomNormal(0,1e-4),s+=o.randomNormal(0,1e-4);c=a===s&&0===s?0/0:Math.atan2(-s,-a),r&&0>c&&(c+=2*Math.PI),i.push(c)}return g=new e(m,l,g,this.model),i=new e(m,l,i,this.model),o.aToObj([g,i,h,n],["slope","aspect","dzdx","dzdy"])},e.prototype.subset=function(t,r,i,h){var n,a,s,l,u,p,c,d,f;for((t+i>this.width||r+h>this.height)&&o.error("subSet: params out of range"),n=[],s=l=p=r,c=r+h;c>l;s=l+=1)for(a=u=d=t,f=t+i;f>u;a=u+=1)n.push(this.getXY(a,s));return new e(i,h,n,this.model)},e}(),ABM.AscDataSet=t=function(t){function e(t,r){this.str=null!=t?t:"",this.model=r,e.__super__.constructor.call(this),0!==this.str.length&&this.parse(this.str)}return h(e,t),e.prototype.parse=function(t){var e,r,i,o,h,n,a,s,l;for(this.str=t,l=this.str.split("\n"),this.header={},e=r=0;5>=r;e=++r)i=l[e].split(/\s+/),this.header[i[0].toLowerCase()]=parseFloat(i[1]);for(e=o=0,a=this.header.nrows;a>o;e=o+=1){for(n=l[6+e].trim().split(" "),e=h=0,s=n.length;s>=0?s>h:h>s;e=s>=0?++h:--h)n[e]=parseFloat(n[e]);this.data=this.data.concat(n)}return this.reset(this.header.ncols,this.header.nrows,this.data)},e}(e),ABM.ImageDataSet=r=function(t){function e(t,r,i,h,n){this.f=null!=r?r:o.pixelByte(0),this.arrayType=null!=i?i:Uint8ClampedArray,this.rowsPerSlice=h,this.model=n,e.__super__.constructor.call(this),null!=t&&this.parse(t)}return h(e,t),e.prototype.parse=function(t){var e;return this.rowsPerSlice||(this.rowsPerSlice=t.height),e=o.imageRowsToData(t,this.rowsPerSlice,this.f,this.arrayType),this.reset(t.width,t.height,e)},e}(e),ABM.PatchDataSet=i=function(t){function e(t,r,i){var h,n,a,s,l,u;for(null==r&&(r=Array),this.model=i,h=new r((u=this.model.patches).length),o.isString(t)&&(t=o.propFcn(t)),n=a=0,s=u.length;s>a;n=++a)l=u[n],h[n]=t(l);e.__super__.constructor.call(this,u.numX,u.numY,h),this.useNearest=!0}return h(e,t),e.prototype.toPatchVar=function(t){var e,r,i,o,h;for(h=this.model.patches,e=r=0,i=h.length;i>r;e=++r)o=h[e],o[t]=this.data[e];return null},e}(e)}).call(this);