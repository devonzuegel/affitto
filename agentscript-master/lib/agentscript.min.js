(function(){var AgentSet,Animator,Color,ColorMaps,Evented,Link,Links,Model,Patch,Patches,Shapes,Turtle,Turtles,Util,colorMixin,u,util,hasProp={}.hasOwnProperty,indexOf=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1},slice=[].slice,extend=function(t,e){function n(){this.constructor=t}for(var r in e)hasProp.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},bind=function(t,e){return function(){return t.apply(e,arguments)}};Util=util=u={error:function(t){throw new Error(t)},loggedMsgs:[],logOnce:function(t){return this.loggedMsgs.indexOf(t)<0?(console.log(t),this.loggedMsgs.push(t)):void 0},deprecatedAlert:!1,deprecated:function(t){return this.deprecatedAlert&&(alert("Deprecated functions, see console.log"),this.deprecatedAlert=!1),this.logOnce("DEPRECATED - "+t)},MaxINT:Math.pow(2,53),MinINT:-Math.pow(2,53),MaxINT32:2147483647,MinINT32:-2147483648,isArray:Array.isArray||function(t){return"[object Array]"===toString.call(t)},isFunction:function(t){return"function"==typeof t},isString:function(t){return"string"==typeof t||t instanceof String},isInteger:Number.isInteger||function(t){return Math.floor(t)===t},isObject:function(t){return"[object Object]"===toString.call(t)},randomSeed:function(t){return null==t&&(t=123456),Math.random=function(){var e;return e=1e4*Math.sin(t++),e-Math.floor(e)}},randomInt:function(t){return Math.floor(Math.random()*t)},randomInt2:function(t,e){return t+Math.floor(Math.random()*(e-t))},randomNormal:function(t,e){var n,r,o;return null==t&&(t=0),null==e&&(e=1),r=1-Math.random(),o=Math.random(),n=Math.sqrt(-2*Math.log(r))*Math.cos(2*Math.PI*o),n*e+t},randomFloat:function(t){return Math.random()*t},randomFloat2:function(t,e){return t+Math.random()*(e-t)},randomCentered:function(t){return this.randomFloat2(-t/2,t/2)},log10:function(t){return Math.log(t)/Math.LN10},log2:function(t){return this.logN(t,2)},logN:function(t,e){return Math.log(t)/Math.log(e)},mod:function(t,e){return(t%e+e)%e},wrap:function(t,e,n){return e+this.mod(t-e,n-e)},clamp:function(t,e,n){return e>t?e:t>n?n:t},sign:function(t){return 0>t?-1:1},fixed:function(t,e){return null==e&&(e=2),e=Math.pow(10,e),Math.round(t*e)/e},aToFixed:function(t,e){var n,r,o,i;for(null==e&&(e=2),i=[],o=0,r=t.length;r>o;o++)n=t[o],i.push(n.toFixed(e));return i},tls:function(t){return t.toLocaleString()},upperCamelCase:function(t){return t.charAt(0).toUpperCase()+t.substr(1)},randomColor:function(t){return null==t&&(t=[]),this.deprecated("Util.randomColor: use ColorMaps.randomColor"),0!==t.length&&this.error("Util.randomColor: c cannot be exiting color"),ColorMaps.randomColor()},randomGray:function(t,e,n){return null==t&&(t=[]),null==e&&(e=64),null==n&&(n=192),2===arguments.length?this.randomGray(null,t,e):(this.deprecated("Util.randomGray: use ColorMaps.randomGray"),0!==t.length&&this.error("Util.randomGray: c cannot be exiting color"),ColorMaps.randomGray(e,n))},randomMapColor:function(t,e){return null==t&&(t=[]),null==e&&(e=[0,63,127,191,255]),this.deprecated("Util.randomMapColor: use ColorMaps.randomColor() or similar"),0!==t.length&&this.error("Util.randomMapColor: c cannot be exiting color"),ColorMaps.randomColor()},setColor:function(t,e,n,r,o){return this.deprecated("Util.setColor: use the Color/ColorMaps modules"),null!=t.setColor?t.map?this.error("Util.setColor: cannot modify colormap colors"):t.setColor(e,n,r,o):(t[0]=e,t[1]=n,t[2]=r,null!=o&&(t[3]=o)),t},setGray:function(t,e,n){return this.deprecated("Util.setGray: use the Color/ColorMaps modules"),this.setColor(t,e,e,e,n)},scaleColor:function(t,e,n){return null==n&&(n=[]),this.deprecated("Util.scaleColor: use the Color/ColorMaps modules"),this.error("Util.scaleColor: cannot modify colormap colors"),ColorMaps.Rgb.findClosestColor(Color.rgbLerp(t,e))},scaleOpacity:function(t,e,n){return null==n&&(n=this.clone(t)),this.deprecated("Util.scaleOpacity: use the Color/ColorMaps modules"),this.isArray(t)?(null==n[3]&&(n[3]=1),n[3]=this.lerp(0,n[3],e)):(n[3]=this.lerp(0,n[3],e),n.map?n=Color.typedColor.apply(Color,n):n.setColor.apply(n,n)),n},colorStr:function(t){var e;return this.deprecated("Util.colorStr: use Color module or typedColor"),null!=(e=t.css)?e:Color.arrayToColor(t,"css")},colorsEqual:function(t,e){return this.deprecated("Util.colorsEqual: use Color/ColorMaps or typedColor.pixel"),Color.colorsEqual(t,e)},rgbToGray:function(t){return this.deprecated("Util.rgbToGray: use Color.rgbIntensity"),Color.rgbIntensity.apply(Color,t)},rgbToHsb:function(t){var e,n,r,o,i,s,l,u,a;if(this.deprecated("Util.rgbToHsb: use extras/rgbToHsl"),l=t[0]/255,r=t[1]/255,e=t[2]/255,i=Math.max(l,r,e),s=Math.min(l,r,e),a=i,o=0,n=i-s,u=0===i?0:n/i,i!==s)switch(i){case l:o=(r-e)/n+(e>r?6:0);break;case r:o=(e-l)/n+2;break;case e:o=(l-r)/n+4}return[Math.round(255*o/6),Math.round(255*u),Math.round(255*a)]},hsbToRgb:function(t){var e,n,r,o,i,s,l,u,a,h,c;switch(this.deprecated("Util.hsbToRgb: use Color/ColorMaps HSL functions"),o=t[0]/255,a=t[1]/255,c=t[2]/255,i=Math.floor(6*o),n=6*o-i,s=c*(1-a),l=c*(1-n*a),h=c*(1-(1-n)*a),i%6){case 0:u=c,r=h,e=s;break;case 1:u=l,r=c,e=s;break;case 2:u=s,r=c,e=h;break;case 3:u=s,r=l,e=c;break;case 4:u=h,r=s,e=c;break;case 5:u=c,r=s,e=l}return[Math.round(255*u),Math.round(255*r),Math.round(255*e)]},rgbMap:function(t,e,n){return null==e&&(e=t),null==n&&(n=t),this.deprecated("Util.rgbMap: use ColorMaps.rgbColorMap or Rgb/Rgb256"),ColorMaps.rgbColorMap(t,e,n)},grayMap:function(){return this.deprecated("Util.grayMap: use ColorMaps.grayColorMap or Gray"),ColorMaps.Gray},hsbMap:function(t,e,n){return null==t&&(t=256),null==e&&(e=255),null==n&&(n=255),this.deprecated("Util.hsbMap: use ColorMaps.hslColorMap"),ColorMaps.hslColorMap(t,1,1)},isLittleEndian:function(){var t;return t=new Uint32Array([16909060]),4===new Uint8ClampedArray(t.buffer)[0]},degToRad:function(t){return t*Math.PI/180},radToDeg:function(t){return 180*t/Math.PI},subtractRads:function(t,e){var n,r;return r=t-e,n=Math.PI,-n>=r&&(r+=2*n),r>n&&(r-=2*n),r},ownKeys:function(t){var e,n,r;n=[];for(e in t)hasProp.call(t,e)&&(r=t[e],n.push(e));return n},ownVarKeys:function(t){var e,n,r;n=[];for(e in t)hasProp.call(t,e)&&(r=t[e],this.isFunction(r)||n.push(e));return n},ownValues:function(t){var e,n,r;n=[];for(e in t)hasProp.call(t,e)&&(r=t[e],n.push(r));return n},mixinObject:function(t,e){var n,r,o,i,s;for(r=Object.getOwnPropertyNames(e),i=0,o=r.length;o>i;i++)n=r[i],s=Object.getOwnPropertyDescriptor(e,n),Object.defineProperty(t,n,s);return t},cloneObject:function(t){var e;return e=Object.create(Object.getPrototypeOf(t)),this.mixinObject(e,t)},cloneClass:function(oldClass,newName){var ctorStr;return ctorStr=oldClass.toString().replace(/^/,"var ctor = "),newName&&(ctorStr=ctorStr.replace(/function.*(?=\()/,"function "+newName)),eval(ctorStr),ctor.prototype=this.cloneObject(oldClass.prototype),ctor},mixin:function(t,e){var n,r,o,i;for(r in e)hasProp.call(e,r)&&(t[r]=e[r]);n=Object.getPrototypeOf(t),i=Object.getPrototypeOf(e),o=[];for(r in i)hasProp.call(i,r)&&o.push(n[r]=i[r]);return o},parseToPrimitive:function(t){var e;try{return JSON.parse(t)}catch(n){return e=n,decodeURIComponent(t)}},parseQueryString:function(t){var e,n,r,o,i,s;for(null==t&&(t=window.location.search.substring(1)),o={},r=t.split("&"),n=0,e=r.length;e>n;n++)i=r[n],0!==t.length&&(s=i.split("="),o[s[0]]=1===s.length?!0:this.parseToPrimitive(s[1]));return o},any:function(t){return 0!==t.length},empty:function(t){return 0===t.length},clone:function(t,e,n){var r;return r=null!=t.slice?"slice":"subarray",null!=e?t[r](e,n):t[r](0)},last:function(t){return this.empty(t)&&this.error("last: empty array"),t[t.length-1]},oneOf:function(t){return this.empty(t)&&this.error("oneOf: empty array"),t[this.randomInt(t.length)]},nOf:function(t,e){var n,r;for(e=Math.min(t.length,Math.floor(e)),r=[];r.length<e;)n=this.oneOf(t),indexOf.call(r,n)<0&&r.push(n);return r},contains:function(t,e,n){return this.indexOf(t,e,n)>=0},removeItem:function(t,e,n){var r;return(r=this.indexOf(t,e,n))<0||t.splice(r,1),t},removeItems:function(t,e,n){var r,o,i;for(i=0,o=e.length;o>i;i++)r=e[i],this.removeItem(t,r,n);return t},insertItem:function(t,e,n){var r;return r=this.sortedIndex(t,e,n),t[r]===e&&error("insertItem: item already in array"),t.splice(r,0,e)},shuffle:function(t){return t.sort(function(){return.5-Math.random()})},minOneOf:function(t,e,n){var r,o,i,s,l,u;for(null==e&&(e=this.identity),null==n&&(n=!1),this.empty(t)&&this.error("minOneOf: empty array"),l=1/0,s=null,this.isString(e)&&(e=this.propFcn(e)),i=0,o=t.length;o>i;i++)r=t[i],(u=e(r))<l&&(l=u,s=r);return n?[s,l]:s},maxOneOf:function(t,e,n){var r,o,i,s,l,u;for(null==e&&(e=this.identity),null==n&&(n=!1),this.empty(t)&&this.error("maxOneOf: empty array"),l=-1/0,s=null,this.isString(e)&&(e=this.propFcn(e)),i=0,o=t.length;o>i;i++)r=t[i],(u=e(r))>l&&(l=u,s=r);return n?[s,l]:s},firstOneOf:function(t,e){var n,r,o,i;for(r=i=0,o=t.length;o>i;r=++i)if(n=t[r],e(n))return r;return-1},histOf:function(t,e,n){var r,o,i,s,l,u,a,h,c;for(null==e&&(e=1),null==n&&(n=function(t){return t}),a=[],this.isString(n)&&(n=this.propFcn(n)),u=0,s=t.length;s>u;u++)r=t[u],i=Math.floor(n(r)/e),a[i]=null!=(h=a[i])?h+1:1;for(i=o=0,l=a.length;l>o;i=++o)c=a[i],null==c&&(a[i]=0);return a},sortBy:function(t,e){return this.isString(e)?t.sort(function(t,n){return t[e]-n[e]}):t.sort(function(t,n){return e(t)-e(n)})},sortNums:function(t,e){var n;return null==e&&(e=!0),n=e?function(t,e){return t-e}:function(t,e){return e-t},null!=t.sort?t.sort(n):Array.prototype.sort.call(t,n)},uniq:function(t){var e,n,r;if(t.length<2)return t;for(e=n=r=t.length-1;n>=1;e=n+=-1)t[e-1]===t[e]&&t.splice(e,1);return t},flatten:function(t){return t.reduce(function(t,e){return t.concat(e)})},aProp:function(t,e){var n,r,o,i,s,l,u;if("function"==typeof e){for(l=[],s=0,o=t.length;o>s;s++)n=t[s],l.push(e(n));return l}for(u=[],r=0,i=t.length;i>r;r++)n=t[r],u.push(n[e]);return u},aToObj:function(t,e){var n,r,o,i;for(n=o=0,r=e.length;r>o;n=++o)i=e[n],t[i]=t[n];return t},aMax:function(t){var e,n,r,o;for(o=t[0],r=0,n=t.length;n>r;r++)e=t[r],o=Math.max(o,e);return o},aMin:function(t){var e,n,r,o;for(o=t[0],r=0,n=t.length;n>r;r++)e=t[r],o=Math.min(o,e);return o},aSum:function(t){var e,n,r,o;for(o=0,r=0,n=t.length;n>r;r++)e=t[r],o+=e;return o},aAvg:function(t){return this.aSum(t)/t.length},aMid:function(t){return t=null!=t.sort?this.clone(t):this.typedToJS(t),this.sortNums(t),t[Math.floor(t.length/2)]},aStats:function(t){var e,n,r,o;return o=this.aMin(t),n=this.aMax(t),e=this.aAvg(t),r=this.aMid(t),{min:o,max:n,avg:e,mid:r}},aNaNs:function(t){var e,n,r,o,i;for(o=[],e=r=0,n=t.length;n>r;e=++r)i=t[e],isNaN(i)&&o.push(e);return o},aRange:function(t,e,n){var r,o,i,s,l,u;for(null==n&&(n=1),l=[],u=r=o=t,i=e,s=n;s>0?i>=r:r>=i;u=r+=s)l.push(u);return l},aRamp:function(t,e,n){var r,o,i,s;for(s=[],r=o=0,i=n;i>=0?i>o:o>i;r=i>=0?++o:--o)s.push(t+(e-t)*(r/(n-1)));return s},aIntRamp:function(t,e,n){var r,o,i,s,l;for(s=this.aRamp(t,e,n),l=[],o=0,r=s.length;r>o;o++)i=s[o],l.push(Math.round(i));return l},aPairwise:function(t,e,n){var r,o,i,s,l;for(l=0,s=[],r=i=0,o=t.length;o>i;r=++i)l=t[r],s.push(n(l,e[r]));return s},aPairSum:function(t,e){return this.aPairwise(t,e,function(t,e){return t+e})},aPairDif:function(t,e){return this.aPairwise(t,e,function(t,e){return t-e})},aPairMul:function(t,e){return this.aPairwise(t,e,function(t,e){return t*e})},typedToJS:function(t){var e,n,r,o;for(o=[],r=0,n=t.length;n>r;r++)e=t[r],o.push(e);return o},lerp:function(t,e,n){return n=this.clamp(n,0,1),e>=t?t+(e-t)*n:t-(t-e)*n},lerpScale:function(t,e,n){return(t-e)/(n-e)},lerp2:function(t,e,n,r,o){return[this.lerp(t,n,o),this.lerp(e,r,o)]},normalize:function(t,e,n){var r,o,i,s,l,u,a;for(null==e&&(e=0),null==n&&(n=1),s=this.aMin(t),i=this.aMax(t),a=1/(i-s),u=[],o=0,r=t.length;r>o;o++)l=t[o],u.push(this.lerp(e,n,a*(l-s)));return u},normalize8:function(t){return new Uint8ClampedArray(this.normalize(t,-.5,255.5))},normalizeInt:function(t,e,n){var r,o,i,s,l;for(s=this.normalize(t,e,n),l=[],i=0,o=s.length;o>i;i++)r=s[i],l.push(Math.round(r));return l},sortedIndex:function(t,e,n){var r,o,i,s;for(null==n&&(n=function(t){return t}),this.isString(n)&&(n=this.propFcn(n)),s=n(e),o=0,r=t.length;r>o;)i=o+r>>>1,n(t[i])<s?o=i+1:r=i;return o},identity:function(t){return t},propFcn:function(t){return function(e){return e[t]}},indexOf:function(t,e,n){var r;return null!=n?(r=this.sortedIndex(t,e,""===n?null:n),t[r]===e?r:-1):t.indexOf(e)},radsToward:function(t,e,n,r){return Math.atan2(r-e,n-t)},inRect:function(t,e,n,r,o,i){return t>=n&&o>=t&&e>=r&&i>=e},inCenteredRect:function(t,e,n,r,o,i){return t>=n-o&&n+o>=t&&e>=r-i&&r+i>=e},inCone:function(t,e,n,r,o,i,s){var l;return t<this.distance(r,o,i,s)?!1:(l=this.radsToward(r,o,i,s),e/2>=Math.abs(this.subtractRads(n,l)))},distance:function(t,e,n,r){var o,i;return o=t-n,i=e-r,Math.sqrt(o*o+i*i)},sqDistance:function(t,e,n,r){var o,i;return o=t-n,i=e-r,o*o+i*i},polarToXY:function(t,e,n,r){return null==n&&(n=0),null==r&&(r=0),[n+t*Math.cos(e),r+t*Math.sin(e)]},torusDistance:function(t,e,n,r,o,i){return Math.sqrt(this.torusSqDistance(t,e,n,r,o,i))},torusSqDistance:function(t,e,n,r,o,i){var s,l,u,a;return s=Math.abs(n-t),u=Math.abs(r-e),l=Math.min(s,o-s),a=Math.min(u,i-u),l*l+a*a},torusWraps:function(t,e,n,r,o,i){var s,l;return s=Math.abs(n-t),l=Math.abs(r-e),s>o-s||l>i-l},torus4Pts:function(t,e,n,r,o,i){var s,l;return s=t>n?n+o:n-o,l=e>r?r+i:r-i,[[n,r],[s,r],[n,l],[s,l]]},torusPt:function(t,e,n,r,o,i){var s,l,u,a;return l=t>n?n+o:n-o,a=e>r?r+i:r-i,s=Math.abs(l-t)<Math.abs(n-t)?l:n,u=Math.abs(a-e)<Math.abs(r-e)?a:r,[s,u]},torusRadsToward:function(t,e,n,r,o,i){var s;return s=this.torusPt(t,e,n,r,o,i),n=s[0],r=s[1],this.radsToward(t,e,n,r)},inTorusCone:function(t,e,n,r,o,i,s,l,u){var a,h,c,p;for(p=this.torus4Pts(r,o,i,s,l,u),h=0,a=p.length;a>h;h++)if(c=p[h],this.inCone(t,e,n,r,o,c[0],c[1]))return!0;return!1},inTorusRect:function(t,e,n,r,o,i,s,l){return n>t?t+=s:t>o&&(t-=s),r>e?e+=l:e>i&&(e-=l),t>=n&&o>=t&&e>=r&&i>=e},fileIndex:{},importImage:function(t,e){var n;return null==e&&(e=function(){}),null!=(n=this.fileIndex[t])?e(n):(this.fileIndex[t]=n=new Image,n.isDone=!1,n.crossOrigin="Anonymous",n.onload=function(){return e(n),n.isDone=!0},n.src=t),n},xhrLoadFile:function(t,e,n,r){var o;return null==e&&(e="GET"),null==n&&(n="text"),null==r&&(r=function(){}),null!=(o=this.fileIndex[t])?r(o.response):(this.fileIndex[t]=o=new XMLHttpRequest,o.isDone=!1,o.open(e,t),o.responseType=n,o.onload=function(){return r(o.response),o.isDone=!0},o.send()),o},filesLoaded:function(t){var e,n;return null==t&&(t=this.fileIndex),e=function(){var e,r,o,i;for(o=this.ownValues(t),i=[],r=0,e=o.length;e>r;r++)n=o[r],i.push(n.isDone);return i}.call(this),e.reduce(function(t,e){return t&&e},!0)},waitOnFiles:function(t,e){return null==e&&(e=this.fileIndex),this.waitOn(function(t){return function(){return t.filesLoaded(e)}}(this),t)},waitOn:function(t,e){return t()?e():setTimeout(function(n){return function(){return n.waitOn(t,e)}}(this),1e3)},cloneImage:function(t){var e;return(e=new Image).src=t.src,e},imageToData:function(t,e,n){return null==e&&(e=this.pixelByte(0)),null==n&&(n=Uint8ClampedArray),this.imageRowsToData(t,t.height,e,n)},imageRowsToData:function(t,e,n,r){var o,i,s,l,u,a,h,c,p;for(null==n&&(n=this.pixelByte(0)),null==r&&(r=Uint8ClampedArray),p=0,i=new r(t.width*t.height);p<t.height;){for(c=Math.min(t.height-p,e),o=this.imageSliceToCtx(t,0,p,t.width,c),u=this.ctxToImageData(o).data,s=p*t.width,l=a=0,h=u.length/4;h>a;l=a+=1)i[s+l]=n(u,4*l);p+=c}return i},pixelBytesToInt:function(t){var e;return e=[[2],[1,2],[0,1,2],[3,0,1,2]],"number"==typeof t&&(t=e[t-1]),function(e,n){var r,o,i,s;for(s=0,i=0,o=t.length;o>i;i++)r=t[i],s=256*s+e[n+r];return s}},pixelByte:function(t){return function(e,n){return e[n+t]}},createCanvas:function(t,e){var n;return n=document.createElement("canvas"),n.width=t,n.height=e,n},createCtx:function(t,e,n){var r,o;return null==n&&(n="2d"),r=this.createCanvas(t,e),"2d"===n?r.getContext("2d"):null!=(o=r.getContext("webgl"))?o:r.getContext("experimental-webgl")},createLayer:function(t,e,n,r,o){var i;return null==o&&(o="2d"),"img"===o?(i=o=new Image,o.width=e,o.height=n):i=(o=this.createCtx(e,n,o)).canvas,this.insertLayer(t,i,e,n,r),o},insertLayer:function(t,e,n,r,o){var i;return i=e.style,i.position="absolute",i.top=0,i.left=0,i.width=n,i.height=r,i.zIndex=o,t.appendChild(e)},setCtxSmoothing:function(t,e){var n,r,o,i;for(n=["imageSmoothingEnabled","mozImageSmoothingEnabled","oImageSmoothingEnabled","webkitImageSmoothingEnabled","msImageSmoothingEnabled"],o=0,r=n.length;r>o;o++)if(i=n[o],null!=t[i])return t[i]=e},setIdentity:function(t){return t.save(),t.setTransform(1,0,0,1,0,0)},clearCtx:function(t){return null!=t.save?(this.setIdentity(t),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.restore()):(t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT))},fillCtx:function(t,e){var n;return null!=t.fillStyle?(this.setIdentity(t),t.fillStyle=null!=(n=e.css)?n:Color.convertColor(e,"css"),t.fillRect(0,0,t.canvas.width,t.canvas.height),t.restore()):(t.clearColor.apply(t,slice.call(e).concat([1])),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT))},ctxDrawText:function(t,e,n,r,o,i){return null==i&&(i=!0),i&&this.setIdentity(t),t.fillStyle=o.css,t.fillText(e,n,r),i?t.restore():void 0},ctxTextParams:function(t,e,n,r){return null==n&&(n="center"),null==r&&(r="middle"),t.font=e,t.textAlign=n,t.textBaseline=r},elementTextParams:function(t,e,n,r){return null==n&&(n="center"),null==r&&(r="middle"),null!=t.canvas&&(t=t.canvas),t.style.font=e,t.style.textAlign=n,t.style.textBaseline=r},imageToCtx:function(t,e,n){var r;return null!=e&&null!=n?(r=this.createCtx(e,n),r.drawImage(t,0,0,e,n)):(r=this.createCtx(t.width,t.height),r.drawImage(t,0,0)),r},imageSliceToCtx:function(t,e,n,r,o,i){return null!=i?(i.canvas.width=r,i.canvas.height=o):i=this.createCtx(r,o),i.drawImage(t,e,n,r,o,0,0,r,o),i},imageToCtxDownStepped:function(t,e,n){var r,o,i,s,l,u,a,h,c,p;if(i=this.createCtx(e,n),p=t.width,s=t.height,l=function(t){return Math.ceil(t/2)},c=Math.ceil(this.log2(p/e>s/n?p/e:s/n)),console.log("steps",c),1>=c)i.drawImage(t,0,0,e,n);else{for(console.log("img w/h",p,s,"->",l(p),l(s)),o=this.createCtx(p=l(p),s=l(s)),r=o.canvas,o.drawImage(t,0,0,p,s),h=u=a=c;2>=a?2>u:u>2;h=2>=a?++u:--u)console.log("can w/h",p,s,"->",l(p),l(s)),o.drawImage(r,0,0,p,s,0,0,p=l(p),s=l(s));console.log("target w/h",p,s,"->",e,n),i.drawImage(r,0,0,p,s,0,0,e,n)}return i},ctxToDataUrl:function(t){return t.canvas.toDataURL("image/png")},ctxToDataUrlImage:function(t,e){var n;return n=new Image,null!=e&&(n.onload=function(){return e(n)}),n.src=t.canvas.toDataURL("image/png"),n},ctxToImageData:function(t){return t.getImageData(0,0,t.canvas.width,t.canvas.height)},drawCenteredImage:function(t,e,n,r,o,i,s){return t.translate(r,o),t.rotate(n),t.drawImage(e,-i/2,-s/2)},copyCtx:function(t){var e;return e=this.createCtx(t.canvas.width,t.canvas.height),e.drawImage(t.canvas,0,0),e},resizeCtx:function(t,e,n,r){var o;return null==r&&(r=!1),o=this.copyCtx(t),t.canvas.width=e,t.canvas.height=n,t.drawImage(o.canvas,0,0)}},Evented=function(){function t(){this.events={}}return t.prototype.emit=function(){var t,e,n,r,o,i,s;if(o=arguments[0],t=2<=arguments.length?slice.call(arguments,1):[],this.events[o]){for(i=this.events[o],s=[],r=0,n=i.length;n>r;r++)e=i[r],s.push(e.apply(null,t));return s}},t.prototype.on=function(t,e){var n;return(null!=(n=this.events)[t]?n[t]:n[t]=[]).push(e)},t.prototype.off=function(t,e){var n;return this.events[t]?e?this.events[t]=function(){var r,o,i,s;for(i=this.events[t],s=[],o=0,r=i.length;r>o;o++)n=i[o],n!==e&&s.push(n);return s}.call(this):delete this.events[t]:void 0},t}(),Color={rgbaString:function(t,e,n,r){var o;return null==r&&(r=255),r/=255,o=r.toPrecision(4),1===r?"rgb("+t+","+e+","+n+")":"rgba("+t+","+e+","+n+","+o+")"},hslString:function(t,e,n,r){var o;return null==r&&(r=255),r/=255,o=r.toPrecision(4),1===r?"hsl("+t+","+e+"%,"+n+"%)":"hsla("+t+","+e+"%,"+n+"%,"+o+")"},hexString:function(t,e,n,r){var o,i,s;return null==r&&(r=!0),r&&u.isInteger(s=t/17)&&u.isInteger(i=e/17)&&u.isInteger(o=n/17)?this.hexShortString(s,i,o):"#"+(16777216|(n|e<<8|t<<16)).toString(16).slice(-6)},hexShortString:function(t,e,n){return(t>15||e>15||n>15)&&u.error("hexShortString: one of "+[t,e,n]+" > 15"),"#"+t.toString(16)+e.toString(16)+n.toString(16)},triString:function(t,e,n,r){return null==r&&(r=255),255===r?this.hexString(t,e,n,!0):this.rgbaString(t,e,n,r)},sharedCtx1x1:u.createCtx(1,1),stringToUint8s:function(t){return this.sharedCtx1x1.fillStyle=t,this.sharedCtx1x1.fillRect(0,0,1,1),this.sharedCtx1x1.getImageData(0,0,1,1).data},sharedPixel:null,sharedUint8s:null,initSharedPixel:function(){return this.sharedPixel=new Uint32Array(1),this.sharedUint8s=new Uint8ClampedArray(this.sharedPixel.buffer)},rgbaToPixel:function(t,e,n,r){return null==r&&(r=255),this.sharedUint8s.set([t,e,n,r]),this.sharedPixel[0]},pixelToUint8s:function(t,e){return null==e&&(e=!1),this.sharedPixel[0]=t,e?this.sharedUint8s:new Uint8ClampedArray(this.sharedUint8s)},randomRgb:function(){var t,e,n;for(n=[],t=e=0;2>=e;t=++e)n.push(u.randomInt(256));return n},randomGrayRgb:function(t,e){var n;return null==t&&(t=0),null==e&&(e=256),n=u.randomInt2(t,e),[n,n,n]},uint8sToRgba:function(t){return Array.apply(null,t)},rgbIntensity:function(t,e,n){return.2126*t+.7152*e+.0722*n},hslToRgb:function(t,e,n){var r;return r=this.hslString(t,e,n),this.stringToUint8s(r).subarray(0,3)},rgbDistance:function(t,e,n,r,o,i){var s,l,u,a,h;return a=Math.round((t+r)/2),h=[t-r,e-o,n-i],u=h[0],l=h[1],s=h[2],Math.sqrt(((512+a)*u*u>>8)+4*l*l+((767-a)*s*s>>8))},rgbLerp:function(t,e,n,r,o){var i,s,l,a;for(null==n&&(n=0),null==r&&(r=1),null==o&&(o=[0,0,0]),a=u.lerpScale(e,n,r),l=[],i=s=0;2>=s;i=++s)l.push(Math.round(u.lerp(o[i],t[i],a)));return l},typedColor:function(){var t,e;return e=function(e,n,r,o){var i;return null==o&&(o=255),i=e.buffer?e:new Uint8ClampedArray([e,n,r,o]),i.pixelArray=new Uint32Array(i.buffer,i.byteOffset,1),i.__proto__=t,i},t={__proto__:Uint8ClampedArray.prototype,setColor:function(t,e,n,r){return null==r&&(r=255),this.checkColorChange(),this[0]=t,this[1]=e,this[2]=n,this[3]=r,this},setPixel:function(t){return this.checkColorChange(),this.pixelArray[0]=t},getPixel:function(){return this.pixelArray[0]},setString:function(t){return this.setColor.apply(this,Color.stringToUint8s(t))},getString:function(){return null==this.string&&(this.string=Color.triString.apply(Color,this)),this.string},checkColorChange:function(){return this.map&&u.error("ColorMap.typedColor: cannot modify ColorMap color."),this.string?this.string=null:void 0},clone:function(){return typeColor.apply(null,this)}},Object.defineProperties(t,{pixel:{get:function(){return this.pixelArray[0]},set:function(t){return this.setPixel(t)},enumerable:!0},rgba:{get:function(){return this},set:function(t){return this.setColor.apply(this,t)},enumerable:!0},css:{get:function(){return this.getString()},set:function(t){return this.setString(t)},enumerable:!0},str:{get:function(){return this.getString()},enumerable:!0}}),e}(),colorType:function(t){return t.pixelArray?"typed":u.isString(t)?"css":u.isInteger(t)?"pixel":null},arrayToColor:function(t,e){switch(null==e&&(e="typed"),e){case"css":return this.triString.apply(this,t);case"pixel":return this.rgbaToPixel.apply(this,t);case"typed":return t.buffer?this.typedColor(t):this.typedColor.apply(this,t)}return u.error("arrayToColor: incorrect type: "+e)},colorToArray:function(t){switch(this.colorType(t)){case"css":return this.stringToUint8s(t);case"pixel":return this.pixelToUint8s(t);case"typed":return t}return u.isArray(t)||t.buffer?t:u.error("colorToArray: bad color: "+t)},convertColor:function(t,e){var n;return n=this.colorType(t),n===e&&"css"!==e?t:"typed"===n?t[e]:this.arrayToColor(this.colorToArray(t),e)},rgbaToColor:function(t,e,n,r,o){switch(null==r&&(r=255),null==o&&(o="typed"),o){case"css":return this.triString(t,e,n,r);case"pixel":return this.rgbaToPixel(t,e,n,r);case"typed":return this.typedColor(t,e,n,r)}return u.error("rgbaToColor: incorrect type: "+o)},colorsEqual:function(t,e){return this.convertColor(t,"pixel")===this.convertColor(e,"pixel")}},Color.initSharedPixel(),ColorMaps={gradientImageData:function(t,e,n){var r,o,i,s,l,a;for(e=function(){var t,n,o;for(o=[],n=0,t=e.length;t>n;n++)r=e[n],o.push(Color.convertColor(r,"css"));return o}(),null==n&&(n=u.aRamp(0,1,e.length)),o=u.createCtx(t,1),i=o.createLinearGradient(0,0,t,0),s=l=0,a=e.length;a>=0?a>l:l>a;s=a>=0?++l:--l)i.addColorStop(n[s],e[s]);return o.fillStyle=i,o.fillRect(0,0,t,1),u.ctxToImageData(o).data},uint8ArrayToUint8s:function(t){var e,n,r,o;for(o=[],e=n=0,r=t.length;r>n;e=n+=4)o.push(t.subarray(e,e+4));return o},uint8ArrayToRgbas:function(t){var e,n,r,o;for(o=[],e=n=0,r=t.length;r>n;e=n+=4)o.push([t[e],t[e+1],t[e+2],t[e+3]]);return o},uint8ArrayToColors:function(t,e){return"pixel"===e?new Uint32Array(t.buffer):this.arrayToColors(this.uint8ArrayToUint8s(t),e)},arrayToColors:function(t,e){var n,r,o,i;if(Color.colorType(t[0])===e)return t;for(r=i=0,o=t.length;o>i;r=++i)n=t[r],t[r]=Color.convertColor(n,e);return t},permuteColors:function(t,e,n,r){var o,i,s;return null==e&&(e=t),null==n&&(n=e),null==r&&(r=[255,255,255]),s=function(){var s,l,a,h;for(a=[t,e,n],h=[],i=l=0,s=a.length;s>l;i=++l)o=a[i],"number"==typeof o?1===o?h.push([r[i]]):h.push(u.aIntRamp(0,r[i],o)):h.push(o);return h}(),t=s[0],e=s[1],n=s[2],this.permuteArrays(t,e,n)},permuteArrays:function(t,e,n){var r,o,i,s,l,u,a,h,c,p;for(null==e&&(e=t),null==n&&(n=e),u=[],p=0,a=n.length;a>p;p++)for(i=n[p],s=0,h=e.length;h>s;s++)for(o=e[s],l=0,c=t.length;c>l;l++)r=t[l],u.push([r,o,i]);return u},colorMap:function(t,e){return null==e&&(e=!1),t.__proto__=this.ColorMapProto,t.init(e)},ColorMapProto:{__proto__:Array.prototype,init:function(t){var e,n,r,o,i,s;if(null==t&&(t=!1),this.type=Color.colorType(this[0]),t&&(this.index={}),null==this.type&&u.error("ColorMap type error"),"typed"===this.type)for(r=s=0,o=this.length;o>s;r=++s)n=this[r],n.ix=r,n.map=this;if(this.index)for(r=e=0,i=this.length;i>e;r=++e)n=this[r],this.index[this.indexKey(n)]=r;return this},indexKey:function(t){return"typed"===this.type?t.pixel:t},colorsEqual:function(t,e){return this.indexKey(t)===this.indexKey(e)},randomIndex:function(t,e){return null==t&&(t=0),null==e&&(e=this.length),u.randomInt2(t,e)},randomColor:function(t,e){return null==t&&(t=0),null==e&&(e=this.length),this[this.randomIndex(t,e)]},sort:function(t){var e,n,r,o,i,s;if(Array.prototype.sort.call(this,t),this.index)for(r=s=0,o=this.length;o>s;r=++s)n=this[r],this.index[this.indexKey(n)]=r;if("typed"===this.type)for(r=e=0,i=this.length;i>e;r=++e)n=this[r],n.ix=r;return this},lookup:function(t){var e,n,r,o;if(t=Color.convertColor(t,this.type),this.index)return this.index[this.indexKey(t)];for(n=o=0,r=this.length;r>o;n=++o)if(e=this[n],this.colorsEqual(t,e))return n;return void 0},scaleColor:function(t,e,n){var r;return e>t&&(t=e),t>n&&(t=n),r=(this.length-1)*((t-e)/(n-e)),this[Math.round(r)]},findClosestIndex:function(t,e,n,r){var o,i,s,l,u,a,h,c,p,f,d,g,y,m,x,v,C,w,S;if(null==r&&(r=255),null==e&&(v=Color.colorToArray(t),t=v[0],e=v[1],n=v[2],r=v[3]),this.cube)return S=255/(this.cube-1),C=function(){var r,o,i,l;for(i=[t,e,n],l=[],o=0,r=i.length;r>o;o++)s=i[o],l.push(Math.round(s/S));return l}(),x=C[0],h=C[1],i=C[2],x+h*this.cube+i*this.cube*this.cube;if(p=this.lookup([t,e,n,r]))return p;for(y=1/0,f=0,c=g=0,d=this.length;d>g;c=++g)l=this[c],w=Color.colorToArray(l),m=w[0],a=w[1],o=w[2],u=Color.rgbDistance(m,a,o,t,e,n),y>u&&(y=u,f=c);return f},findClosestColor:function(t,e,n,r){return null==r&&(r=255),this[this.findClosestIndex(t,e,n,r)]}},basicColorMap:function(t,e,n){return null==e&&(e="typed"),null==n&&(n=!1),t=this.arrayToColors(t,e),this.colorMap(t,n)},grayColorMap:function(t,e,n){var r,o;return null==t&&(t=256),null==e&&(e="typed"),null==n&&(n=!1),r=function(){var e,n,r,i;for(r=u.aIntRamp(0,255,t),i=[],n=0,e=r.length;e>n;n++)o=r[n],i.push([o,o,o]);return i}(),this.basicColorMap(r,e,n)},rgbColorMap:function(t,e,n,r,o){var i;return null==e&&(e=t),null==n&&(n=t),null==r&&(r="typed"),null==o&&(o=!0),i=this.permuteColors(t,e,n),"number"==typeof t&&t===e&&e===n&&(i.cube=t),this.colorMap(this.arrayToColors(i,r),o)},rgbColorCube:function(t,e,n){return null==e&&(e="typed"),null==n&&(n=!1),this.rgbColorMap(t,t,t,e,n)},hslColorMap:function(t,e,n,r,o){var i,s,l;return null==e&&(e=1),null==n&&(n=1),null==r&&(r="typed"),null==o&&(o=!1),l=this.permuteColors(t,e,n,[359,100,50]),s=function(){var t,e,n;for(n=[],e=0,t=l.length;t>e;e++)i=l[e],n.push(Color.hslString.apply(Color,i));return n}(),this.colorMap(this.arrayToColors(s,r),o)},gradientColorMap:function(t,e,n,r,o){var i;return null==r&&(r="typed"),null==o&&(o=!1),i=this.gradientImageData(t,e,n),this.colorMap(this.uint8ArrayToColors(i,r),o)},jetColors:[[0,0,127],[0,0,255],[0,127,255],[0,255,255],[127,255,127],[255,255,0],[255,127,0],[255,0,0],[127,0,0]],rampColorMap:function(t,e,n){var r;return null==n&&(n=!1),r=n?["black",t,"white"]:["black",t],this.gradientColorMap(e,r)},netLogoColorMap:function(t,e){return null==t&&(t=10),null==e&&(e=!0),this.namedColorMap(this.netLogoColors,t,e)},cssBasicColorMap:function(t,e){return null==t&&(t=18),null==e&&(e=!1),this.namedColorMap(this.basicCssColors,t,e)},namedColorMap:function(t,e,n){var r,o,i,s,l,a,h,c,p,f;if(l=[],p={},u.isArray(t)){for(c={},s=0,i=t.length;i>s;s++)a=t[s],c[a]=a;t=c}for(h in t)r=t[h],p[h]=this.rampColorMap(r,e,n),l=l.concat(p[h]);l=this.basicColorMap(l);for(o in p)f=p[o],l[o]=f;for(o in p)f=p[o],l[Color.convertColor(o,"css")]=f;return l},basicCssColors:["gray","red","orange","brown","yellow","green","lime","turquoise","cyan","skyblue","blue","violet","magenta","pink"],netLogoColors:{gray:[141,141,141],red:[215,50,41],orange:[241,106,21],brown:[157,110,72],yellow:[237,237,49],green:[89,176,60],lime:[44,209,59],turquoise:[29,159,120],cyan:[84,196,196],skyblue:[45,141,190],blue:[52,93,169],violet:[124,80,164],magenta:[167,27,106],pink:[224,127,150]},opacityColorMap:function(t,e,n,r){var o,i,s,l,a;return null==e&&(e=256),null==n&&(n="typed"),null==r&&(r=!1),a=t[0],l=t[1],s=t[2],i=function(){var t,n,r,i;for(r=u.aIntRamp(0,255,e),i=[],n=0,t=r.length;t>n;n++)o=r[n],i.push([a,l,s,o]);return i}(),this.colorMap(this.arrayToColors(i,n),r)},createSharedMaps:function(){return this.Gray=this.grayColorMap(),this.Rgb256=this.rgbColorMap(8,8,4),this.Rgb=this.rgbColorCube(16),this.Safe=this.rgbColorCube(6),this.Jet=this.gradientColorMap(256,this.jetColors),this.NetLogo=this.netLogoColorMap(10),this.NetLogoRamps=this.netLogoColorMap(18,!1),this.CssRamps=this.cssBasicColorMap(18,!1)},randomGray:function(t,e){return this.Gray.randomColor(t,e)},randomColor:function(){return this.Rgb256.randomColor()},scaleColor:function(t,e,n,r){var o;return null==n&&(n=0),null==r&&(r=1),null!=t.scaleColor?t.scaleColor(e,n,r):(o=this.CssRamps[Color.convertColor(t,"css")])?o.scaleColor(e,n,r):this.Rgb.findClosestColor(Color.rgbLerp(t,e,n,r))}},ColorMaps.createSharedMaps(),colorMixin=function(t,e,n,r){var o,i,s,l,a,h;return null==r&&(r="typed"),l=null!=(a=t.prototype)?a:t,i=u.upperCamelCase(e),o=e+"Prop",s="get"+i,h="set"+i,l[o]=n?Color.convertColor(n,r):null,null==l[h]&&(l[h]=function(t,e,n,i){var s;return null==i&&(i=255),void 0===e?s=Color.convertColor(t,r):this.hasOwnProperty(o)&&"typed"===r&&null==(s=this[o]).map?s.setColor(t,e,n,i):(console.log("new color"),s=Color.rgbaToColor(t,e,n,i,r)),this[o]=s}),null==l[s]&&(l[s]=function(){return this[o]}),Object.defineProperty(l,e,{get:function(){return this[s]()},set:function(t){return this[h](t)}}),l},Shapes=function(){var t,e,n,r,o,i,s;return i=function(t,e){var n,r,o,i;for(n=o=0,r=e.length;r>o;n=++o)i=e[n],0===n?t.moveTo(i[0],i[1]):t.lineTo(i[0],i[1]);return null},n=function(t,e,n,r){return t.arc(e,n,r/2,0,2*Math.PI)},t=function(t,e,n,r){return t.arc(e,n,r/2,0,2*Math.PI,!0)
},e=function(t,e,n,r,o){return t.scale(1,-1),t.drawImage(o,e-r/2,n-r/2,r,r),t.scale(1,-1)},r=function(t,e,n,r){return t.fillRect(e-r/2,n-r/2,r,r)},o=function(t,e){return t.ctx.save(),t.ctx.scale(1,-1),t.ctx.drawImage(e,t.x,-(t.y+t.spriteSize),t.spriteSize,t.spriteSize),t.ctx.restore()},s=[],{"default":{rotate:!0,draw:function(t){return i(t,[[.5,0],[-.5,-.5],[-.25,0],[-.5,.5]])}},triangle:{rotate:!0,draw:function(t){return i(t,[[.5,0],[-.5,-.4],[-.5,.4]])}},arrow:{rotate:!0,draw:function(t){return i(t,[[.5,0],[0,.5],[0,.2],[-.5,.2],[-.5,-.2],[0,-.2],[0,-.5]])}},bug:{rotate:!0,draw:function(t){return"#000000"===t.strokeStyle&&(t.strokeStyle=t.fillStyle),t.lineWidth=.05,i(t,[[.4,.225],[.2,0],[.4,-.225]]),t.stroke(),t.beginPath(),n(t,.12,0,.26),n(t,-.05,0,.26),n(t,-.27,0,.4)}},pyramid:{rotate:!1,draw:function(t){return i(t,[[0,.5],[-.433,-.25],[.433,-.25]])}},circle:{shortcut:function(t,e,r,o){return t.beginPath(),n(t,e,r,o),t.closePath(),t.fill()},rotate:!1,draw:function(t){return n(t,0,0,1)}},square:{shortcut:function(t,e,n,o){return r(t,e,n,o)},rotate:!1,draw:function(t){return r(t,0,0,1)}},pentagon:{rotate:!1,draw:function(t){return i(t,[[0,.45],[-.45,.1],[-.3,-.45],[.3,-.45],[.45,.1]])}},ring:{rotate:!1,draw:function(e){return n(e,0,0,1),e.closePath(),t(e,0,0,.6)}},filledRing:{rotate:!1,draw:function(t){var e;return n(t,0,0,1),e=t.fillStyle,t.fillStyle=t.strokeStyle,t.fill(),t.fillStyle=e,t.beginPath(),n(t,0,0,.8)}},person:{rotate:!1,draw:function(t){return i(t,[[.15,.2],[.3,0],[.125,-.1],[.125,.05],[.1,-.15],[.25,-.5],[.05,-.5],[0,-.25],[-.05,-.5],[-.25,-.5],[-.1,-.15],[-.125,.05],[-.125,-.1],[-.3,0],[-.15,.2]]),t.closePath(),n(t,0,.35,.3)}},names:function(){var t,e,n;e=[];for(t in this)hasProp.call(this,t)&&(n=this[t],null!=n.rotate&&null!=n.draw&&e.push(t));return e},add:function(t,n,r,o){var i;return i=this[t]=u.isFunction(r)?{rotate:n,draw:r}:{rotate:n,img:r,draw:function(t){return e(t,.5,.5,1,this.img)}},null==i.img||i.rotate||(i.shortcut=function(t,n,r,o){return e(t,n,r,o,this.img)}),null!=o?i.shortcut=o:void 0},poly:i,circ:n,ccirc:t,cimg:e,csq:r,spriteSheets:s,draw:function(t,e,n,r,o,i,s,l){return null!=e.shortcut?(null==e.img&&(t.fillStyle=s.css),e.shortcut(t,n,r,o)):(t.save(),t.translate(n,r),1!==o&&t.scale(o,o),0!==i&&t.rotate(i),null!=e.img?e.draw(t):(t.fillStyle=s.css,l&&(t.strokeStyle=l.css),t.beginPath(),e.draw(t),t.closePath(),t.fill()),t.restore()),e},drawSprite:function(t,e,n,r,o,i){return 0===i?t.drawImage(e.ctx.canvas,e.x,e.y,e.spriteSize,e.spriteSize,n-o/2,r-o/2,o,o):(t.save(),t.translate(n,r),t.rotate(i),t.drawImage(e.ctx.canvas,e.x,e.y,e.spriteSize,e.spriteSize,-o/2,-o/2,o,o),t.restore()),e},shapeToSprite:function(t,e,n,r){var i,l,a,h,c,p,f,d,g;return e=Color.convertColor(e,"css"),null!=r&&(r=Color.convertColor(r,"css")),f=Math.ceil(n),c=this[t],h=null!=c.img?t:t+"-"+e,i=s[f],null==i&&(s[f]=i=u.createCtx(10*f,f),i.nextX=0,i.nextY=0,i.index={}),null!=(l=i.index[h])?l:(f*i.nextX===i.canvas.width&&(u.resizeCtx(i,i.canvas.width,i.canvas.height+f),i.nextX=0,i.nextY++),d=f*i.nextX,g=f*i.nextY,p={ctx:i,x:d,y:g,spriteSize:f,name:t,color:e,strokeColor:r,index:h},i.index[h]=p,null!=(a=c.img)?0!==a.height?o(p,a):a.onload=function(){return o(p,a)}:(i.save(),i.scale(f,f),i.translate(i.nextX+.5,i.nextY+.5),i.fillStyle=e,r&&(i.strokeStyle=r),i.beginPath(),c.draw(i),i.closePath(),i.fill(),i.restore()),i.nextX++,p)}}}(),AgentSet=function(superClass){function AgentSet(t,e,n,r){this.model=t,this.agentClass=e,this.name=n,this.mainSet=r,AgentSet.__super__.constructor.call(this,0),u.mixin(this,new Evented),null==this.mainSet&&(this.breeds=[]),this.agentClass.prototype.breed=this,this.agentClass.prototype.model=this.model,this.ownVariables=[],null==this.mainSet&&(this.ID=0)}return extend(AgentSet,superClass),AgentSet.asSet=function(t,e){var n;return null==e&&(e=AgentSet),t.__proto__=null!=(n=e.prototype)?n:e.constructor.prototype,null!=t[0]&&(t.model=t[0].model),t},AgentSet.prototype.create=function(){},AgentSet.prototype.add=function(t){return null!=this.mainSet?this.mainSet.add(t):t.id=this.ID++,this.push(t),t},AgentSet.prototype.remove=function(t){return null!=this.mainSet&&u.removeItem(this.mainSet,t),u.removeItem(this,t),this},AgentSet.prototype.setDefault=function(t,e){return this.agentClass.prototype[t]=e},AgentSet.prototype.getDefault=function(t){return this.agentClass.prototype[t]},AgentSet.prototype.own=function(t){var e,n,r,o;for(o=t.split(" "),n=0,e=o.length;e>n;n++)r=o[n],this.setDefault(r,null),this.ownVariables.push(r);return this},AgentSet.prototype.setBreed=function(t){var e,n,r;null!=t.breed.mainSet&&u.removeItem(t.breed,t,"id"),null!=this.mainSet&&u.insertItem(this,t,"id"),n=t.__proto__=this.agentClass.prototype;for(e in t)hasProp.call(t,e)&&(r=t[e],null!=n[e]&&delete t[e]);return t},AgentSet.prototype.exclude=function(t){var e;return t=t.split(" "),this.asSet(function(){var n,r,o,i;for(i=[],r=0,n=this.length;n>r;r++)e=this[r],o=e.breed.name,indexOf.call(t,o)<0&&i.push(e);return i}.call(this))},AgentSet.prototype.uniq=function(){return u.uniq(this)},AgentSet.prototype.asSet=function(t,e){return null==e&&(e=AgentSet),AgentSet.asSet(t,e)},AgentSet.prototype.isSet=function(t){return null==t&&(t="AgentSet"),this.constructor.name===t},AgentSet.prototype.isBreed=function(t){return null!=this.agentClass?this.agentClass.name===t:this.isSet(t)},AgentSet.prototype.asOrderedSet=function(t){return this.asSet(t).sortById()},AgentSet.prototype.toString=function(){var t;return"["+function(){var e,n,r;for(r=[],n=0,e=this.length;e>n;n++)t=this[n],r.push(t.toString());return r}.call(this).join(", ")+"]"},AgentSet.prototype.getProp=function(t){return u.aProp(this,t)},AgentSet.prototype.getPropWith=function(t,e){var n;return this.asSet(function(){var r,o,i;for(i=[],o=0,r=this.length;r>o;o++)n=this[o],n[t]===e&&i.push(n);return i}.call(this))},AgentSet.prototype.setProp=function(t,e){var n,r,o,i,s,l;if(u.isArray(e)){for(r=s=0,o=this.length;o>s;r=++s)l=this[r],l[t]=e[r];return this}for(n=0,i=this.length;i>n;n++)l=this[n],l[t]=e;return this},AgentSet.prototype.maxProp=function(t){return u.aMax(this.getProp(t))},AgentSet.prototype.minProp=function(t){return u.aMin(this.getProp(t))},AgentSet.prototype.histOfProp=function(t,e){return null==e&&(e=1),u.histOf(this,e,t)},AgentSet.prototype.shuffle=function(){return u.shuffle(this)},AgentSet.prototype.sortById=function(){return u.sortBy(this,"id")},AgentSet.prototype.clone=function(){return this.asSet(u.clone(this))},AgentSet.prototype.last=function(){return u.last(this)},AgentSet.prototype.any=function(){return u.any(this)},AgentSet.prototype.other=function(t){var e;return this.isSet()?u.removeItem(this,t):this.asSet(function(){var n,r,o;for(o=[],r=0,n=this.length;n>r;r++)e=this[r],e!==t&&o.push(e);return o}.call(this))},AgentSet.prototype.oneOf=function(){return u.oneOf(this)},AgentSet.prototype.nOf=function(t){return this.asSet(u.nOf(this,t))},AgentSet.prototype.minOneOf=function(t,e){return null==e&&(e=!1),u.minOneOf(this,t,e)},AgentSet.prototype.maxOneOf=function(t,e){return null==e&&(e=!1),u.maxOneOf(this,t,e)},AgentSet.prototype.draw=function(t){var e,n,r;for(u.clearCtx(t),n=0,e=this.length;e>n;n++)r=this[n],r.hidden||r.draw(t);return null},AgentSet.prototype.show=function(){var t,e,n,r;for(r=[],e=0,t=this.length;t>e;e++)n=this[e],r.push(n.hidden=!1);return r},AgentSet.prototype.hide=function(){var t,e,n,r;for(r=[],e=0,t=this.length;t>e;e++)n=this[e],r.push(n.hidden=!0);return r},AgentSet.prototype.inRect=function(t,e){var n,r,o,i,s,l,u,a,h,c,p,f,d;for(p=[],u=t.x-e,s=t.x+e,a=t.y-e,l=t.y+e,c=this.model.patches,h=u<c.minX||s>c.maxX||a<c.minY||l>c.maxY,r=c.isTorus&&h,i=0,o=this.length;o>i;i++)n=this[i],f=n.x,d=n.y,r&&(u>f?f+=c.numX:f>s&&(f-=c.numX),a>d?d+=c.numY:d>l&&(d-=c.numY)),f>=u&&s>=f&&d>=a&&l>=d&&p.push(n);return this.asSet(p)},AgentSet.prototype.inRadius=function(t,e){var n,r,o,i,s,l;return r=e*e,s=t.x,l=t.y,this.model.patches.isTorus?(i=this.model.patches.numX,o=this.model.patches.numY,this.asSet(function(){var t,e,a;for(a=[],e=0,t=this.length;t>e;e++)n=this[e],u.torusSqDistance(s,l,n.x,n.y,i,o)<=r&&a.push(n);return a}.call(this))):this.asSet(function(){var t,e,o;for(o=[],e=0,t=this.length;t>e;e++)n=this[e],u.sqDistance(s,l,n.x,n.y)<=r&&o.push(n);return o}.call(this))},AgentSet.prototype.inCone=function(t,e,n,r){var o,i,s,l,a;return l=t.x,a=t.y,this.model.patches.isTorus?(s=this.model.patches.numX,i=this.model.patches.numY,this.asSet(function(){var t,h,c;for(c=[],h=0,t=this.length;t>h;h++)o=this[h],u.inTorusCone(e,n,r,l,a,o.x,o.y,s,i)&&c.push(o);return c}.call(this))):this.asSet(function(){var t,i,s;for(s=[],i=0,t=this.length;t>i;i++)o=this[i],u.inCone(e,n,r,l,a,o.x,o.y)&&s.push(o);return s}.call(this))},AgentSet.prototype.ask=function(f){var len,m,o;for(u.isString(f)&&eval("f=function(o){return "+f+";}"),m=0,len=this.length;len>m;m++)o=this[m],f(o);return this},AgentSet.prototype["with"]=function(f){var o;return u.isString(f)&&eval("f=function(o){return "+f+";}"),this.asSet(function(){var t,e,n;for(n=[],e=0,t=this.length;t>e;e++)o=this[e],f(o)&&n.push(o);return n}.call(this))},AgentSet}(Array),Patch=function(){function t(t,e){this.x=t,this.y=e}return t.prototype.id=null,t.prototype.breed=null,t.prototype.x=null,t.prototype.y=null,t.prototype.n=null,t.prototype.n4=null,t.prototype.hidden=!1,t.prototype.label=null,t.prototype.labelOffset=[0,0],t.prototype.pRect=null,t.prototype.toString=function(){return"{id:"+this.id+" xy:"+[this.x,this.y]+" c:"+this.color+"}"},t.prototype.scaleColor=function(t,e){return u.deprecated("Patch.scaleColor: use ColorMaps ramps or closestColor"),this.color=ColorMaps.scaleColor(t,e)},t.prototype.scaleOpacity=function(t,e){return u.deprecated("Patch.scaleOpacity: use ColorMaps ramps"),this.color=u.scaleOpacity(t,e,this.color)},t.prototype.draw=function(t){var e,n,r;return u.deprecated("Patch.draw not used, Patches.draw uses pixels"),t.fillStyle=this.color.css,t.fillRect(this.x-.5,this.y-.5,1,1),null!=this.label?(e=this.breed.patchXYtoPixelXY(this.x,this.y),n=e[0],r=e[1],u.ctxDrawText(t,this.label,n+this.labelOffset[0],r+this.labelOffset[1],this.labelColor.css)):void 0},t.prototype.inRadius=function(t,e){return t.inRadius(this,e)},t.prototype.turtlesHere=function(){var t,e;return this.turtles||u.deprecated("Patch.turtlesHere: make caching default"),null!=(e=this.turtles)?e:function(){var e,n,r,o;for(r=this.model.turtles,o=[],n=0,e=r.length;e>n;n++)t=r[n],t.p===this&&o.push(t);return o}.call(this)},t.prototype.breedsHere=function(t){var e,n,r,o,i;for(o=this.turtlesHere(),i=[],r=0,n=o.length;n>r;r++)e=o[r],e.breed===t&&i.push(e);return i},t.prototype.isOnEdge=function(){return this.x===this.breed.minX||this.x===this.breed.maxX||this.y===this.breed.minY||this.y===this.breed.maxY},t.prototype.sprout=function(t,e,n){return null==t&&(t=1),null==e&&(e=this.model.turtles),null==n&&(n=function(){}),e.create(t,function(t){return function(e){return e.setXY(t.x,t.y),n(e),e}}(this))},t}(),colorMixin(Patch,"color","black"),colorMixin(Patch,"labelColor","black"),Patches=function(t){function e(){var t,n,r;e.__super__.constructor.apply(this,arguments),this.monochrome=!1,n=this.model.world;for(t in n)hasProp.call(n,t)&&(r=n[t],this[t]=r);null==this.mainSet&&this.populate()}return extend(e,t),e.prototype.drawWithPixels=!0,e.prototype.populate=function(){var t,e,n,r,o,i,s,l;for(l=e=n=this.maxY,r=this.minY;e>=r;l=e+=-1)for(s=t=o=this.minX,i=this.maxX;i>=t;s=t+=1)this.add(new this.agentClass(s,l));return this.hasNeighbors&&this.setNeighbors(),null!=this.model.div?this.setPixels():void 0},e.prototype.cacheTurtlesHere=function(){var t,e,n;for(e=0,t=this.length;t>e;e++)n=this[e],n.turtles=[];return null},e.prototype.usePixels=function(){return u.deprecated("Patches.usePixels: pixels always used (color.pixel)")},e.prototype.cacheRect=function(t,e){var n,r,o;for(null==e&&(e=!0),r=0,n=this.length;n>r;r++)o=this[r],o.pRect=this.patchRect(o,t,t,e),o.pRect.radius=t;return null},e.prototype.setNeighbors=function(){var t,e,n,r;for(e=0,t=this.length;t>e;e++)r=this[e],r.n=this.patchRect(r,1,1,!1),r.n4=this.asSet(function(){var t,e,o,i;for(o=r.n,i=[],t=0,e=o.length;e>t;t++)n=o[t],(n.x===r.x||n.y===r.y)&&i.push(n);return i}());return null},e.prototype.setPixels=function(){var t;return t=this.model.contexts.patches,u.setCtxSmoothing(t,!1),this.pixelsCtx=1===this.size?t:u.createCtx(this.numX,this.numY),this.pixelsImageData=this.pixelsCtx.getImageData(0,0,this.numX,this.numY),this.pixelsData=this.pixelsImageData.data,this.drawWithPixels?this.pixelsData32=new Uint32Array(this.pixelsData.buffer):void 0},e.prototype.draw=function(t){return this.monochrome?u.fillCtx(t,this.agentClass.prototype.color):this.drawScaledPixels(t)},e.prototype.patchIndex=function(t,e){return t-this.minX+this.numX*(this.maxY-e)},e.prototype.patchXY=function(t,e){return this[this.patchIndex(t,e)]},e.prototype.clamp=function(t,e){return[u.clamp(t,this.minXcor,this.maxXcor),u.clamp(e,this.minYcor,this.maxYcor)]},e.prototype.wrap=function(t,e){return[u.wrap(t,this.minXcor,this.maxXcor),u.wrap(e,this.minYcor,this.maxYcor)]},e.prototype.coord=function(t,e){return this.isTorus?this.wrap(t,e):this.clamp(t,e)},e.prototype.isOnWorld=function(t,e){return this.isTorus||this.minXcor<=t&&t<=this.maxXcor&&this.minYcor<=e&&e<=this.maxYcor},e.prototype.patch=function(t,e){var n;return n=this.coord(t,e),t=n[0],e=n[1],t=u.clamp(Math.round(t),this.minX,this.maxX),e=u.clamp(Math.round(e),this.minY,this.maxY),this.patchXY(t,e)},e.prototype.randomPt=function(){return[u.randomFloat2(this.minXcor,this.maxXcor),u.randomFloat2(this.minYcor,this.maxYcor)]},e.prototype.toBits=function(t){return t*this.size},e.prototype.fromBits=function(t){return t/this.size},e.prototype.patchRect=function(t,e,n,r){var o,i,s,l,u,a,h,c,p,f;if(null==n&&(n=e),null==r&&(r=!0),null!=t.pRect&&t.pRect.radius===e&&e===n)return t.pRect;for(l=[],f=i=u=t.y-n,a=t.y+n;a>=i;f=i+=1)for(p=o=h=t.x-e,c=t.x+e;c>=o;p=o+=1)(this.isTorus||this.minX<=p&&p<=this.maxX&&this.minY<=f&&f<=this.maxY)&&(this.isTorus&&(p<this.minX?p+=this.numX:p>this.maxX&&(p-=this.numX),f<this.minY?f+=this.numY:f>this.maxY&&(f-=this.numY)),s=this.patchXY(p,f),(r||t!==s)&&l.push(s));return this.asSet(l)},e.prototype.inRect=function(t,e){var n;return this.patchRect(null!=(n=t.p)?n:t,Math.ceil(e))},e.prototype.inRadius=function(t,e){var n,r;return n=this.patchRect(null!=(r=t.p)?r:t,Math.ceil(e)),n.inRadius(t,e)},e.prototype.inCone=function(t,e,n,r){var o,i;return o=this.patchRect(null!=(i=t.p)?i:t,Math.ceil(e)),o.inRadius(t,e,n,r)},e.prototype.turtlesOnRect=function(t,e,n){return null==n&&(n=e),this.turtlesOnPatches(this.patchRect(t,e,n,!0))},e.prototype.turtlesOnPatches=function(t){var e,n,r,o;if(e=[],0!==t.length)for(null==t[0].turtles&&u.error("turtlesOnPatches: no cached turtles."),r=0,n=t.length;n>r;r++)o=t[r],Array.prototype.push.apply(e,o.turtles);return this.asSet(e)},e.prototype.patchesOf=function(t){var e,n;return null==t.length?this.asSet([null!=(n=t.p)?n:t]):this.asSet(function(){var n,r,o,i;for(i=[],r=0,n=t.length;n>r;r++)e=t[r],i.push(null!=(o=e.p)?o:e);return i}()).sortById().uniq()},e.prototype.turtlesOf=function(t){return this.turtlesOnPatches(this.patchesOf(t))},e.prototype.importDrawing=function(t,e){return u.importImage(t,function(t){return function(n){return t.installDrawing(n),null!=e?e():void 0}}(this))},e.prototype.installDrawing=function(t,e){return null==e&&(e=this.model.contexts.drawing),u.setIdentity(e),e.drawImage(t,0,0,e.canvas.width,e.canvas.height),e.restore()},e.prototype.pixelByteIndex=function(t){return 4*t.id},e.prototype.pixelWordIndex=function(t){return t.id},e.prototype.pixelXYtoPatchXY=function(t,e){return[this.minXcor+t/this.size,this.maxYcor-e/this.size]},e.prototype.patchXYtoPixelXY=function(t,e){return[(t-this.minXcor)*this.size,(this.maxYcor-e)*this.size]},e.prototype.importColors=function(t,e,n){return u.importImage(t,function(t){return function(r){return t.installColors(r,n),null!=e?e():void 0}}(this))},e.prototype.installColors=function(t,e){var n,r,o,i,s;for(u.setIdentity(this.pixelsCtx),this.pixelsCtx.drawImage(t,0,0,this.numX,this.numY),n=this.pixelsCtx.getImageData(0,0,this.numX,this.numY).data,i=0,o=this.length;o>i;i++)s=this[i],r=this.pixelByteIndex(s),s.color=null!=e?e[r]:[n[r++],n[r++],n[r]];return this.pixelsCtx.restore()},e.prototype.drawScaledPixels=function(t){var e,n,r,o,i,s,l;if(1!==this.size&&u.setIdentity(t),n=null!=(l=this.pixelsData32)?l:this.pixelsData,null!=this.pixelsData32)for(i=0,r=this.length;r>i;i++)s=this[i],n[s.id]=s.color.pixel;else for(e=0,o=this.length;o>e;e++)s=this[e],n.set(s.color,4*s.id);return this.pixelsCtx.putImageData(this.pixelsImageData,0,0),1!==this.size?(t.drawImage(this.pixelsCtx.canvas,0,0,this.pxWidth,this.pxHeight),1!==this.size?t.restore():void 0):void 0},e.prototype.diffuse=function(t,e,n){var r,o,i,s,l,u,a,h,c,p,f,d,g,y;if(null==this[0]._diffuseNext)for(p=0,u=this.length;u>p;p++)g=this[p],g._diffuseNext=0;for(r=0,a=this.length;a>r;r++)for(g=this[r],s=g[t]*e,l=s/8,d=g.n.length,g._diffuseNext+=g[t]-s+(8-d)*l,y=g.n,o=0,h=y.length;h>o;o++)f=y[o],f._diffuseNext+=l;for(i=0,c=this.length;c>i;i++)g=this[i],g[t]=g._diffuseNext,g._diffuseNext=0,null!=n&&(g.color=ColorMaps.scaleColor(n,g[t]));return null},e}(AgentSet),Turtle=function(){function t(){this.x=this.y=0,this.p=this.model.patches.patch(this.x,this.y),null==this.color&&(this.color=u.randomColor()),null==this.heading&&(this.heading=u.randomFloat(2*Math.PI)),null!=this.p.turtles&&this.p.turtles.push(this),this.cacheLinks&&(this.links=[])}return t.prototype.id=null,t.prototype.breed=null,t.prototype.x=0,t.prototype.y=0,t.prototype.p=null,t.prototype.size=1,t.prototype.color=null,t.prototype.strokeColor=null,t.prototype.shape="default",t.prototype.hidden=!1,t.prototype.label=null,t.prototype.labelColor=[0,0,0],t.prototype.labelOffset=[0,0],t.prototype.penDown=!1,t.prototype.penSize=1,t.prototype.heading=null,t.prototype.sprite=null,t.prototype.useSprites=!1,t.prototype.cacheLinks=!1,t.prototype.links=null,t.prototype.scaleColor=function(t,e){return u.deprecated("Turtle.scaleColor: use ColorMaps ramps or closestColor"),this.color=ColorMaps.scaleColor(t,e)},t.prototype.scaleOpacity=function(t,e){return u.deprecated("Turtle.scaleOpacity: use ColorMaps ramps"),this.color=u.scaleOpacity(t,e,this.color)},t.prototype.toString=function(){var t;return"{id:"+this.id+" xy:"+u.aToFixed([this.x,this.y])+" c:"+this.color.css+" h: "+(t=this.heading.toFixed(2))+"/"+Math.round(u.radToDeg(t))+"}"},t.prototype.setXY=function(t,e){var n,r,o,i,s,l;return this.penDown&&(o=[this.x,this.y],s=o[0],l=o[1]),i=this.model.patches.coord(t,e),this.x=i[0],this.y=i[1],r=this.p,this.p=this.model.patches.patch(this.x,this.y),null!=r.turtles&&r!==this.p&&(u.removeItem(r.turtles,this),this.p.turtles.push(this)),this.penDown?(n=this.model.drawing,n.strokeStyle=this.color.css,n.lineWidth=this.model.patches.fromBits(this.penSize),n.beginPath(),n.moveTo(s,l),n.lineTo(t,e),n.stroke()):void 0},t.prototype.moveTo=function(t){return this.setXY(t.x,t.y)},t.prototype.forward=function(t){return this.setXY(this.x+t*Math.cos(this.heading),this.y+t*Math.sin(this.heading))},t.prototype.rotate=function(t){return this.heading=u.wrap(this.heading+t,0,2*Math.PI)},t.prototype.right=function(t){return this.rotate(-t)},t.prototype.left=function(t){return this.rotate(t)},t.prototype.draw=function(t){var e,n,r,o,i;return r=Shapes[this.shape],e=r.rotate?this.heading:0,null!=this.sprite||this.useSprites?(null==this.sprite&&this.setSprite(),Shapes.drawSprite(t,this.sprite,this.x,this.y,this.size,e)):Shapes.draw(t,r,this.x,this.y,this.size,e,this.color,this.strokeColor),null!=this.label?(n=this.model.patches.patchXYtoPixelXY(this.x,this.y),o=n[0],i=n[1],u.ctxDrawText(t,this.label,o+this.labelOffset[0],i+this.labelOffset[1],this.labelColor)):void 0},t.prototype.setSprite=function(t){var e;return null!=(e=t)?(this.sprite=e,this.color=e.color,this.strokeColor=e.strokeColor,this.shape=e.shape,this.size=this.model.patches.fromBits(e.size)):this.sprite=Shapes.shapeToSprite(this.shape,this.color,this.model.patches.toBits(this.size),this.strokeColor)},t.prototype.stamp=function(){return this.draw(this.model.drawing)},t.prototype.distanceXY=function(t,e){return this.model.patches.isTorus?u.torusDistance(this.x,this.y,t,e,this.model.patches.numX,this.model.patches.numY):u.distance(this.x,this.y,t,e)},t.prototype.distance=function(t){return this.distanceXY(t.x,t.y)},t.prototype.torusPtXY=function(t,e){return u.torusPt(this.x,this.y,t,e,this.model.patches.numX,this.model.patches.numY)},t.prototype.torusPt=function(t){return this.torusPtXY(t.x,t.y)},t.prototype.face=function(t){return this.heading=this.towards(t)},t.prototype.towardsXY=function(t,e){var n;return(n=this.model.patches).isTorus?u.torusRadsToward(this.x,this.y,t,e,n.numX,n.numY):u.radsToward(this.x,this.y,t,e)},t.prototype.towards=function(t){return this.towardsXY(t.x,t.y)},t.prototype.patchAtHeadingAndDistance=function(t,e){var n,r,o;return o=u.polarToXY(e,t+this.heading),n=o[0],r=o[1],this.patchAt(n,r)},t.prototype.patchLeftAndAhead=function(t,e){return this.patchAtHeadingAndDistance(t,e)},t.prototype.patchRightAndAhead=function(t,e){return this.patchAtHeadingAndDistance(-t,e)},t.prototype.patchAhead=function(t){return this.patchAtHeadingAndDistance(0,t)},t.prototype.canMove=function(t){return null!=this.patchAhead(t)},t.prototype.patchAt=function(t,e){var n,r,o;return r=this.x+t,o=this.y+e,(n=this.model.patches).isOnWorld(r,o)?n.patch(r,o):null},t.prototype.die=function(){var t,e,n;for(this.breed.remove(this),n=this.myLinks(),e=n.length-1;e>=0;e+=-1)t=n[e],t.die();return null!=this.p.turtles&&u.removeItem(this.p.turtles,this),null},t.prototype.hatch=function(t,e,n){return null==t&&(t=1),null==e&&(e=this.breed),null==n&&(n=function(){}),e.create(t,function(t){return function(r){var o,i,s,l;for(r.setXY(t.x,t.y),r.color=t.color,l=e.ownVariables,s=0,i=l.length;i>s;s++)o=l[s],null===r[o]&&(r[o]=t[o]);return n(r),r}}(this))},t.prototype.inRadius=function(t,e){return t.inRadius(this,e)},t.prototype.inCone=function(t,e,n){return t.inCone(this,e,n,this.heading)},t.prototype.hitTest=function(t,e){return this.distanceXY(t,e)<this.size},t.prototype.otherEnd=function(t){return t.end1===this?t.end2:t.end1},t.prototype.myLinks=function(){var t,e;return null!=(e=this.links)?e:function(){var e,n,r,o;for(r=this.model.links,o=[],n=0,e=r.length;e>n;n++)t=r[n],(t.end1===this||t.end2===this)&&o.push(t);return o}.call(this)},t.prototype.linkNeighbors=function(){var t,e,n,r,o;for(r=this.myLinks(),o=[],n=0,e=r.length;e>n;n++)t=r[n],o.push(this.otherEnd(t));return o},t.prototype.myInLinks=function(){var t,e,n,r,o;for(r=this.myLinks(),o=[],n=0,e=r.length;e>n;n++)t=r[n],t.end2===this&&o.push(t);return o},t.prototype.inLinkNeighbors=function(){var t,e,n,r,o;for(r=this.myLinks(),o=[],n=0,e=r.length;e>n;n++)t=r[n],t.end2===this&&o.push(t.end1);return o},t.prototype.myOutLinks=function(){var t,e,n,r,o;for(r=this.myLinks(),o=[],n=0,e=r.length;e>n;n++)t=r[n],t.end1===this&&o.push(t);return o},t.prototype.outLinkNeighbors=function(){var t,e,n,r,o;for(r=this.myLinks(),o=[],n=0,e=r.length;e>n;n++)t=r[n],t.end1===this&&o.push(t.end2);return o},t}(),colorMixin(Turtle,"color",null),colorMixin(Turtle,"strokeColor",null),colorMixin(Turtle,"labelColor","black"),Turtles=function(t){function e(){e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype.cacheLinks=function(){return this.agentClass.prototype.cacheLinks=!0},e.prototype.setUseSprites=function(t){return null==t&&(t=!0),u.deprecated('Turtles.setUseSprites: use turtles.setDefault("useSprites",bool)'),this.setDefault("useSprites",t)},e.prototype.create=function(t,e){var n,r,o,i;for(null==e&&(e=function(){}),i=[],n=r=1,o=t;o>=r;n=r+=1)i.push(function(t){return e(t),t}(this.add(new this.agentClass)));return i},e.prototype.clear=function(){for(;this.any();)this.last().die();return null},e.prototype.breedsIn=function(t){var e;return this.asSet(function(){var n,r,o;for(o=[],r=0,n=t.length;n>r;r++)e=t[r],e.breed===this&&o.push(e);return o}.call(this))},e.prototype.inPatches=function(t){var e,n,r,o;for(e=[],r=0,n=t.length;n>r;r++)o=t[r],e.push.apply(e,o.turtlesHere());return null!=this.mainSet?this.breedsIn(e):this.asSet(e)},e.prototype.inRect=function(t,e,n){var r;return null==n&&(n=e),r=this.model.patches.patchRect(t,e,n),this.inPatches(r)},e.prototype.inRadius=function(t,e){var n,r;return n=this.inRect(null!=(r=t.p)?r:t,Math.ceil(e)),n.inRadius(t,e)},e.prototype.inCone=function(t,e,n,r){var o,i;return o=this.inRect(null!=(i=t.p)?i:t,Math.ceil(e)),o.inCone(t,e,n,r)},e.prototype.setDraggable=function(){return this.on("dragstart",function(){return function(t){return t.target.dragging=!0}}(this)),this.on("dragend",function(){return function(t){return t.target.dragging=!1}}(this)),this.on("drag",function(){return function(t){return t.target.setXY(t.patchX,t.patchY)}}(this))},e}(AgentSet),Link=function(){function t(t,e){this.end1=t,this.end2=e,null!=this.end1.links&&(this.end1.links.push(this),this.end2.links.push(this))}return t.prototype.id=null,t.prototype.breed=null,t.prototype.end1=null,t.prototype.end2=null,t.prototype.color=[130,130,130],t.prototype.thickness=2,t.prototype.hidden=!1,t.prototype.label=null,t.prototype.labelColor=[0,0,0],t.prototype.labelOffset=[0,0],t.prototype.draw=function(t){var e,n,r,o,i,s,l;return t.save(),t.strokeStyle=this.color.css,t.lineWidth=this.model.patches.fromBits(this.thickness),t.beginPath(),this.model.patches.isTorus?(e=this.end1.torusPt(this.end2),t.moveTo(this.end1.x,this.end1.y),t.lineTo.apply(t,e),(e[0]!==this.end2.x||e[1]!==this.end2.y)&&(e=this.end2.torusPt(this.end1),t.moveTo(this.end2.x,this.end2.y),t.lineTo.apply(t,e))):(t.moveTo(this.end1.x,this.end1.y),t.lineTo(this.end2.x,this.end2.y)),t.closePath(),t.stroke(),t.restore(),null!=this.label?(n=u.lerp2(this.end1.x,this.end1.y,this.end2.x,this.end2.y,.5),i=n[0],l=n[1],r=this.model.patches.patchXYtoPixelXY(i,l),o=r[0],s=r[1],u.ctxDrawText(t,this.label,o+this.labelOffset[0],s+this.labelOffset[1],this.labelColor)):void 0},t.prototype.die=function(){return this.breed.remove(this),null!=this.end1.links&&u.removeItem(this.end1.links,this),null!=this.end2.links&&u.removeItem(this.end2.links,this),null},t.prototype.hitTest=function(t,e){var n,r;return r=u.aSum(function(){var r,o,i,s;for(i=this.bothEnds(),s=[],o=0,r=i.length;r>o;o++)n=i[o],s.push(n.distanceXY(t,e));return s}.call(this)),r-this.length()<.05/this.model.patches.size},t.prototype.bothEnds=function(){return[this.end1,this.end2]},t.prototype.length=function(){return this.end1.distance(this.end2)},t.prototype.otherEnd=function(t){return this.end1===t?this.end2:this.end1},t}(),colorMixin(Link,"color",[130,130,130]),colorMixin(Link,"labelColor","black"),Links=function(t){function e(){e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype.create=function(t,e,n){var r,o,i,s;for(null==n&&(n=function(){}),null==e.length&&(e=[e]),s=[],i=0,o=e.length;o>i;i++)r=e[i],s.push(function(t){return n(t),t}(this.add(new this.agentClass(t,r))));return s},e.prototype.clear=function(){for(;this.any();)this.last().die();return null},e.prototype.allEnds=function(){var t,e,n,r;for(r=this.asSet([]),n=0,e=this.length;e>n;n++)t=this[n],r.push(t.end1,t.end2);return r},e.prototype.nodes=function(){return this.allEnds().sortById().uniq()},e.prototype.layoutCircle=function(t,e,n,r){var o,i,s,l,u;for(null==n&&(n=Math.PI/2),null==r&&(r=-1),i=2*Math.PI/t.length,s=u=0,l=t.length;l>u;s=++u)o=t[s],o.setXY(0,0),o.heading=n+r*i*s,o.forward(e);return null},e.prototype.setDraggable=function(){return this.on("dragstart",function(){return function(t){return t.target.dragging=!0}}(this)),this.on("dragend",function(){return function(t){return t.target.dragging=!1}}(this)),this.on("drag",function(){return function(t){var e,n;return e=t.target.end1,n=t.target.end2,e.setXY(e.x-t.dx,e.y-t.dy),n.setXY(n.x-t.dx,n.y-t.dy)}}(this))},e}(AgentSet),Model=function(){function t(e){var n,r,o,i,s,l;o=t.defaultOptions(),u.isObject(e)||(console.log("option defaults:",o),u.error("Model constructor: use options object; see console for defaults.")),null!=e.isHeadless&&u.deprecated("Model: isHeadless no longer used");for(r in e)l=e[r],void 0===o[r]&&u.error("Bad Model arg: "+r+": "+l),o[r]=l;if(this.setWorld(o),u.mixin(this,new Evented),this.contexts={},null!=o.div){this.div=document.getElementById(o.div),s=this.div.style,s.position="relative",s.width=this.world.pxWidth,s.height=this.world.pxHeight,i=this.contextsInit;for(r in i)hasProp.call(i,r)&&(l=i[r],this.contexts[r]=n=u.createLayer(this.div,this.world.pxWidth,this.world.pxHeight,l.z,l.ctx),null!=n.canvas&&this.setCtxTransform(n),null!=n.canvas&&(n.canvas.style.pointerEvents="none"),u.elementTextParams(n,"10px sans-serif","center","middle"));this.drawing=this.contexts.drawing,this.drawing.clear=function(t){return function(){return u.clearCtx(t.drawing)}}(this),this.contexts.spotlight.globalCompositeOperation="xor"}this.anim=new Animator(this),this.refreshLinks=this.refreshTurtles=this.refreshPatches=!0,this.Patch=u.cloneClass(Patch),this.Turtle=u.cloneClass(Turtle),this.Link=u.cloneClass(Link),this.patches=new Patches(this,this.Patch,"patches"),this.turtles=new Turtles(this,this.Turtle,"turtles"),this.links=new Links(this,this.Link,"links"),this.debugging=!1,this.modelReady=!1,this.globalNames=null,this.globalNames=u.ownKeys(this),this.globalNames.set=!1,this.startup(),u.waitOnFiles(function(t){return function(){return t.modelReady=!0,t.setupAndEmit(),t.globalNames.set?void 0:t.globals()}}(this))}return t.prototype.contextsInit={patches:{z:10,ctx:"2d"},drawing:{z:20,ctx:"2d"},links:{z:30,ctx:"2d"},turtles:{z:40,ctx:"2d"},spotlight:{z:50,ctx:"2d"}},t.nonWorldOptions=["div"],t.defaultOptions=function(){return{div:null,size:13,minX:-16,maxX:16,minY:-16,maxY:16,isTorus:!1,hasNeighbors:!0}},t.prototype.setWorld=function(e){var n,r,o;o={};for(n in e)hasProp.call(e,n)&&(r=e[n],indexOf.call(t.nonWorldOptions,n)<0&&(o[n]=r));return o.numX=o.maxX-o.minX+1,o.numY=o.maxY-o.minY+1,o.pxWidth=o.numX*o.size,o.pxHeight=o.numY*o.size,o.minXcor=o.minX-.5,o.maxXcor=o.maxX+.5,o.minYcor=o.minY-.5,o.maxYcor=o.maxY+.5,this.world=o},t.prototype.setCtxTransform=function(t){return t.canvas.width=this.world.pxWidth,t.canvas.height=this.world.pxHeight,t.save(),t.scale(this.world.size,-this.world.size),t.translate(-this.world.minXcor,-this.world.maxYcor)},t.prototype.globals=function(t){return null!=t?(this.globalNames=t,this.globalNames.set=!0):this.globalNames=u.removeItems(u.ownKeys(this),this.globalNames)},t.prototype.setFastPatches=function(){return this.patches.usePixels()},t.prototype.setMonochromePatches=function(){return this.patches.monochrome=!0},t.prototype.setCacheTurtlesHere=function(){return this.patches.cacheTurtlesHere()},t.prototype.setCacheMyLinks=function(){return this.turtles.cacheLinks()},t.prototype.startup=function(){},t.prototype.setup=function(){},t.prototype.step=function(){},t.prototype.start=function(){return u.waitOn(function(t){return function(){return t.modelReady}}(this),function(t){return function(){return t.anim.start()}}(this)),this},t.prototype.stop=function(){return this.anim.stop()},t.prototype.once=function(){return this.anim.stopped||this.stop(),this.anim.once()},t.prototype.reset=function(t){var e,n,r;null==t&&(t=!1),console.log("reset: anim"),this.anim.reset(),console.log("reset: contexts"),n=this.contexts;for(e in n)r=n[e],null!=r.canvas&&(r.restore(),this.setCtxTransform(r));return console.log("reset: patches"),this.patches=new Patches(this,this.Patch,"patches"),console.log("reset: turtles"),this.turtles=new Turtles(this,this.Turtle,"turtles"),console.log("reset: links"),this.links=new Links(this,this.Link,"links"),Shapes.spriteSheets.length=0,console.log("reset: setup"),this.setupAndEmit(),this.debugging&&this.setRootVars(),t?this.start():void 0},t.prototype.draw=function(t){return null==t&&(t=this.anim.stopped||1===this.anim.draws),this.debugging&&(this.anim.draws%100===0&&console.log(this.anim.toString()),2===this.anim.draws&&this.showSpriteSheet()),null!=this.div&&((t||this.refreshPatches)&&this.patches.draw(this.contexts.patches),(t||this.refreshLinks)&&this.links.draw(this.contexts.links),(t||this.refreshTurtles)&&this.turtles.draw(this.contexts.turtles),null!=this.spotlightTurtle&&this.drawSpotlight(this.spotlightTurtle,this.contexts.spotlight)),this.emit("draw")
},t.prototype.toggleDrawing=function(){return null!=this.div?(this.div0=this.div,this.div=null):(this.div=this.div0,this.div0=null)},t.prototype.setupAndEmit=function(){return this.setup(),this.emit("setup")},t.prototype.stepAndEmit=function(){return this.step(),this.emit("step")},t.prototype.setSpotlight=function(t){return this.spotlightTurtle=t,null==this.spotlightTurtle?u.clearCtx(this.contexts.spotlight):void 0},t.prototype.drawSpotlight=function(t,e){return u.clearCtx(e),u.fillCtx(e,Color.typedColor(0,0,0,153)),e.beginPath(),e.arc(t.x,t.y,3,0,2*Math.PI,!1),e.fill()},t.prototype.createBreeds=function(t,e,n){var r,o,i,s,l,a,h,c;for(s=[],s.classes={},s.sets={},c=t.split(" "),h=0,a=c.length;a>h;h++)i=c[h],l=u.upperCamelCase(i),o=u.cloneClass(e,l),r=this[i]=new n(this,o,i,e.prototype.breed),s.push(r),s.sets[i]=r,s.classes[i+"Class"]=o;return s},t.prototype.patchBreeds=function(t){return this.patches.breeds=this.createBreeds(t,this.Patch,Patches)},t.prototype.agentBreeds=function(t){return this.turtles.breeds=this.createBreeds(t,this.Turtle,Turtles)},t.prototype.linkBreeds=function(t){return this.links.breeds=this.createBreeds(t,this.Link,Links)},t.prototype.asSet=function(t,e){return null==e&&(e=AgentSet),AgentSet.asSet(t,e)},t.prototype.debug=function(t){return this.debugging=null!=t?t:!0,u.waitOn(function(t){return function(){return t.modelReady}}(this),function(t){return function(){return t.setRootVars()}}(this)),this},t.prototype.setRootVars=function(){return window.psc=Patches,window.tsc=Turtles,window.lsc=Links,window.pc=this.Patch,window.tc=this.Turtle,window.lc=this.Link,window.ps=this.patches,window.ts=this.turtles,window.ls=this.links,window.p0=this.patches[0],window.t0=this.turtles[0],window.l0=this.links[0],window.dr=this.drawing,window.u=Util,window.cx=this.contexts,window.an=this.anim,window.gl=this.globals(),window.dv=this.div,window.app=this},t.prototype.showSpriteSheet=function(t){var e;return 0!==Shapes.spriteSheets.length?(e=Util.last(Shapes.spriteSheets),null!=t?document.getElementById(t).appendChild(e.canvas):(e.canvas.setAttribute("style","float:right"),this.div.parentElement.insertBefore(e.canvas,this.div))):console.log("showSpriteSheet: not using sprites")},t}(),this.ABM={Util:Util,Color:Color,ColorMaps:ColorMaps,colorMixin:colorMixin,Shapes:Shapes,AgentSet:AgentSet,Patch:Patch,Patches:Patches,Turtle:Turtle,Turtles:Turtles,Link:Link,Links:Links,Animator:Animator,Evented:Evented,Model:Model},Animator=function(){function t(t,e,n,r){this.model=t,this.rate=null!=e?e:30,this.multiStep=null!=n?n:!1,this.noRAF=null!=r?r:!1,this.animateDraws=bind(this.animateDraws,this),this.animateSteps=bind(this.animateSteps,this),this.reset()}return t.prototype.setRate=function(t,e,n){return this.rate=t,this.multiStep=null!=e?e:!1,this.noRAF=null!=n?n:!1,this.resetTimes()},t.prototype.start=function(){return this.stopped?(this.resetTimes(),this.stopped=!1,this.animate()):void 0},t.prototype.stop=function(){return this.stopped=!0,null==this.animHandle||this.noRAF||cancelAnimationFrame(this.animHandle),null!=this.animHandle&&this.noRAF&&clearTimeout(this.animHandle),null!=this.timeoutHandle&&clearTimeout(this.timeoutHandle),null!=this.intervalHandle&&clearInterval(this.intervalHandle),this.animHandle=this.timerHandle=this.intervalHandle=null},t.prototype.resetTimes=function(){return this.startMS=this.now(),this.startTick=this.ticks,this.startDraw=this.draws},t.prototype.reset=function(){return this.stop(),this.ticks=this.draws=0},t.prototype.step=function(){return this.ticks++,this.model.stepAndEmit()},t.prototype.draw=function(){return this.draws++,this.model.draw()},t.prototype.once=function(){return this.step(),this.draw()},t.prototype.now=function(){return("undefined"!=typeof performance&&null!==performance?performance:Date).now()},t.prototype.ms=function(){return this.now()-this.startMS},t.prototype.ticksPerSec=function(){var t;return 0===(t=this.ticks-this.startTick)?0:Math.round(1e3*t/this.ms())},t.prototype.drawsPerSec=function(){var t;return 0===(t=this.draws-this.startDraw)?0:Math.round(1e3*t/this.ms())},t.prototype.toString=function(){return"ticks: "+this.ticks+", draws: "+this.draws+", rate: "+this.rate+" tps/dps: "+this.ticksPerSec()+"/"+this.drawsPerSec()},t.prototype.animateSteps=function(){return this.step(),this.stopped?void 0:this.timeoutHandle=setTimeout(this.animateSteps,2)},t.prototype.animateDraws=function(){return this.drawsPerSec()<this.rate&&(this.multiStep||this.step(),this.draw()),this.noRAF?(this.stopped||(this.animHandle=setTimeout(this.animateDraws,2)),u.deprecated("avoiding rAF")):this.stopped?void 0:this.animHandle=requestAnimationFrame(this.animateDraws)},t.prototype.animate=function(){return this.multiStep&&this.animateSteps(),this.animateDraws()},t}()}).call(this);