(function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}};t=ABM.Util,ABM.Mouse=function(){function s(t,s){this.model=t,this.callback=s,this.delegateMouseOverAndOutEvents=e(this.delegateMouseOverAndOutEvents,this),this.delegateDragEvents=e(this.delegateDragEvents,this),this.computeEventTypes=e(this.computeEventTypes,this),this.handleMouseEvent=e(this.handleMouseEvent,this),this.handleStep=e(this.handleStep,this),this.handleMouseMove=e(this.handleMouseMove,this),this.handleMouseUp=e(this.handleMouseUp,this),this.handleMouseDown=e(this.handleMouseDown,this),this.lastX=1/0,this.lastY=1/0,this.div=this.model.div,this.lastAgentsHovered=[],this.draggingAgents=[],this.divOffset=this.model.div.getBoundingClientRect(),this.start()}return s.prototype.start=function(){return this.div.addEventListener("mousedown",this.handleMouseDown,!1),document.body.addEventListener("mouseup",this.handleMouseUp,!1),this.div.addEventListener("mousemove",this.handleMouseMove,!1),this.model.on("step",this.handleStep),this.lastX=this.lastY=this.x=this.y=this.pixX=this.pixY=0/0,this.moved=this.down=!1},s.prototype.stop=function(){return this.div.removeEventListener("mousedown",this.handleMouseDown,!1),document.body.removeEventListener("mouseup",this.handleMouseUp,!1),this.div.removeEventListener("mousemove",this.handleMouseMove,!1),this.model.off("step",this.handleStep),this.lastX=this.lastY=this.x=this.y=this.pixX=this.pixY=0/0,this.moved=this.down=!1},s.prototype.handleMouseDown=function(t){return this.down=!0,this.moved=!1,this.handleMouseEvent(t)},s.prototype.handleMouseUp=function(t){return this.down=!1,this.moved=!1,this.handleMouseEvent(t)},s.prototype.handleMouseMove=function(t){return this.setXY(t),this.moved=!0,this.handleMouseEvent(t)},s.prototype.handleStep=function(){return isNaN(this.x)?void 0:this.delegateMouseOverAndOutEvents(this.x,this.y)},s.prototype.handleMouseEvent=function(t){var e;return e=this.computeEventTypes(),this.delegateEventsToAllAgents(e,t),null!=this.callback?this.callback(t):void 0},s.prototype.getEventPos=function(t){var e,s;return e=0,s=0,t.pageX||t.pageY?(e=t.pageX,s=t.pageY):(t.clientX||t.clientY)&&(e=t.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,s=t.clientY+document.body.scrollTop+document.documentElement.scrollTop),{x:e-this.divOffset.left,y:s-this.divOffset.top}},s.prototype.setXY=function(t){var e,s;return e=this.getEventPos(t),this.lastX=this.x,this.lastY=this.y,this.pixX=e.x,this.pixY=e.y,s=this.model.patches.pixelXYtoPatchXY(this.pixX,this.pixY),this.x=s[0],this.y=s[1],this.dx=this.lastX-this.x,this.dy=this.lastY-this.y},s.prototype.computeEventTypes=function(){var t;return t=[],this.down&&!this.moved&&t.push("mousedown"),this.down||this.moved||t.push("mouseup"),this.down&&this.moved&&(this.dragging||t.push("dragstart"),this.dragging=!0),!this.down&&this.dragging&&(this.dragging=!1,this.dragEnd=!0),this.moved&&t.push("mousemove"),t},s.prototype.delegateEventsToAllAgents=function(t,e){var s;return s=this.delegateEventsToTurtlesAtPoint(t,this.x,this.y,e),s||(s=this.delegateEventsToLinksAtPoint(t,this.x,this.y,e)),s||this.delegateEventsToPatchAtPoint(t,this.x,this.y,e),this.delegateDragEvents(this.x,this.y,e),this.delegateMouseOverAndOutEvents(this.x,this.y,e)},s.prototype.delegateEventsToPatchAtPoint=function(t,e,s,i){var n,o,h,d,r;for(n=this.model.patches.patch(e,s),d=[],o=0,h=t.length;h>o;o++)r=t[o],d.push(this.emitAgentEvent(r,n,this.mouseEvent(n,i)));return d},s.prototype.delegateEventsToTurtlesAtPoint=function(t,e,s,i){var n,o,h,d,r,a,l,u,v,g,p,m;for(n=this.model.patches.patch(e,s),v=n.n.concat(n),o=0,r=v.length;r>o;o++)for(u=v[o],g=u.turtlesHere(),h=0,a=g.length;a>h;h++)if(p=g[h],p.hitTest(e,s)){for(d=0,l=t.length;l>d;d++)m=t[d],this.emitAgentEvent(m,p,this.mouseEvent(p,i));return p}},s.prototype.delegateEventsToLinksAtPoint=function(t,e,s,i){var n,o,h,d,r,a,l,u;for(l=this.model.links,n=0,h=l.length;h>n;n++)if(r=l[n],r.hitTest(e,s)){for(a=this.mouseEvent(r,i),o=0,d=t.length;d>o;o++)u=t[o],this.emitAgentEvent(u,r,a);return r}},s.prototype.emitAgentEvent=function(t,e,s){return"dragstart"===t&&this.draggingAgents.push(e),e.breed.emit(t,s),null!=e.breed.mainSet?e.breed.mainSet.emit(t,s):void 0},s.prototype.delegateDragEvents=function(t,e,s){var i,n,o,h,d;for(d=this.draggingAgents,n=0,o=d.length;o>n;n++)i=d[n],h=this.mouseEvent(i,s),this.moved&&this.emitAgentEvent("drag",i,h),this.dragEnd&&this.emitAgentEvent("dragend",i,h);return this.dragEnd?(this.draggingAgents=[],this.dragEnd=!1):void 0},s.prototype.delegateMouseOverAndOutEvents=function(e,s,i){var n,o,h,d,r,a,l,u,v,g,p,m,c;for(d={},h=[],a=this.model.patches.patch(e,s),h=t.clone(this.model.links),c=a.n.concat(a),l=0,v=c.length;v>l;l++)m=c[l],h=h.concat(m.turtlesHere());for(u=0,g=h.length;g>u;u++)n=h[u],n.hitTest(e,s)&&(null==d[p=n.breed.name]&&(d[p]={}),d[n.breed.name][n.id]=n,this.lastAgentsHovered[n.breed.name]&&n.id in this.lastAgentsHovered[n.breed.name]||this.emitAgentEvent("mouseover",n,this.mouseEvent(n,i)));for(r in this.lastAgentsHovered)for(o in this.lastAgentsHovered[r])d[r]&&o in d[r]||(n=this.lastAgentsHovered[r][o],this.emitAgentEvent("mouseout",n,this.mouseEvent(n,i)));return this.lastAgentsHovered=d},s.prototype.mouseEvent=function(t,e){return{target:t,patchX:this.x,patchY:this.y,dx:this.dx,dy:this.dy,originalEvent:e}},s}()}).call(this);